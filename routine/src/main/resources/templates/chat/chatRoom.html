<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <th:block th:replace="~{common/fragment :: library}"></th:block>
    <style>
        body { background-color: #A9BDCE; }
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 120px); max-width: 800px; margin: 20px auto; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background-color: #F8F9FA; }
        #chat-header { background-color: #4F80E1; color: white; padding: 15px 20px; font-size: 1.2em; font-weight: bold; }
        #chatArea { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: #A9BDCE; display: flex; flex-direction: column; }
        .message-row { display: flex; margin-bottom: 15px; max-width: 70%; }
        .message-content { display: flex; flex-direction: column; }
        .message-bubble { padding: 10px 15px; border-radius: 18px; font-size: 0.95em; word-wrap: break-word; max-width: 100%; }
        .sender-name { font-size: 0.85em; color: #495057; margin-bottom: 5px; }
        .message-info { font-size: 0.75em; color: #555; align-self: flex-end; margin: 0 5px; }
        .other-message { align-self: flex-start; }
        .other-message .message-bubble { background-color: #FFFFFF; }
        .my-message { align-self: flex-end; }
        .my-message .message-content { align-items: flex-end; }
        .my-message .message-bubble { background-color: #FEE500; color: #191919; }
        .my-message .message-row { flex-direction: row-reverse; }
        .system-message { text-align: center; font-size: 0.8em; color: white; background-color: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 10px; margin: 10px auto; max-width: fit-content; }
        #chat-input-wrapper { padding: 10px; background-color: #F8F9FA; border-top: 1px solid #E9ECEF; }
        #chat-input-area { display: flex; }
        #messageInput { border-radius: 20px; border-color: #dee2e6; }
        #filePreview { margin-bottom: 10px; }
    </style>
</head>
<body>
    <th:block th:replace="~{common/fragment :: header}"></th:block>

    <div class="chat-container">
        <div id="chat-header" th:if="${meeting != null}">
            <span th:text="${meeting.title}">모임 제목</span>
        </div>
        <div id="chatArea">
            <div th:each="message : ${messages}" th:class="${message.userNo == session.loginUser.userNo} ? 'message-row my-message' : 'message-row other-message'">
                <div class="message-content">
                    <div class="sender-name" th:if="${message.userNo != session.loginUser.userNo}" th:text="${message.userName}"></div>
                    <div class="message-bubble">
                        <th:block th:switch="${message.messageType}">
                            <th:block th:case="'image'">
                                <img th:src="${message.fileUrl}" th:alt="${message.fileName}" style="max-width: 200px; border-radius: 5px;">
                            </th:block>
                            <th:block th:case="'file'">
                                <a th:href="${message.fileUrl}" th:download="${message.fileName}" th:text="${message.fileName}"></a>
                            </th:block>
                            <th:block th:case="*">
                                <span th:text="${message.messageContent}"></span>
                            </th:block>
                        </th:block>
                    </div>
                </div>
                <div class="message-info" th:text="${#temporals.format(message.sentAt, 'HH:mm')}"></div>
            </div>
        </div>
        <div id="chat-input-wrapper">
             <div id="filePreview" style="display: none;">
                <div class="alert alert-info d-flex justify-content-between align-items-center p-2">
                    <span id="fileNamePreview"></span>
                    <button type="button" class="btn-close" onclick="cancelFile()" aria-label="Close"></button>
                </div>
            </div>
            <div id="chat-input-area">
                <button class="btn btn-outline-secondary me-2" type="button" onclick="document.getElementById('fileInput').click()">
                    <i class="bi bi-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
                <input type="text" id="messageInput" class="form-control" placeholder="메시지를 입력하세요..."
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="btn btn-primary ms-2" type="button" onclick="sendMessage()"><i class="bi bi-send"></i></button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        const meetingNo = /*[[${meetingNo}]]*/ 1;
        const currentUserNo = /*[[${session.loginUser.userNo}]]*/ 0;
        const currentUserName = /*[[${session.loginUser.name}]]*/ '사용자';
        let websocket;
        let selectedFile = null;

        window.onload = function() {
            connectWebSocket();
            scrollToBottom();
        };

        function connectWebSocket() {
            const contextPath = /*[[@{/}]]*/ '/';
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${wsProtocol}//${host}${contextPath}chat?meetingNo=${meetingNo}&userNo=${currentUserNo}&userName=${encodeURIComponent(currentUserName)}`;

            websocket = new WebSocket(wsUrl);
            websocket.onopen = () => addSystemMessage('채팅방에 연결되었습니다.');
            websocket.onmessage = (event) => displayMessage(JSON.parse(event.data));
            websocket.onclose = () => addSystemMessage('연결이 종료되었습니다.');
            websocket.onerror = () => addSystemMessage('연결에 오류가 발생했습니다.');
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (selectedFile) {
                sendFileMessage();
            } else if (message !== '') {
                websocket.send(message);
            }
            
            messageInput.value = '';
            messageInput.focus();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            selectedFile = file;
            document.getElementById('fileNamePreview').textContent = file.name;
            document.getElementById('filePreview').style.display = 'block';
        }

        function sendFileMessage() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('meetingNo', meetingNo);

            fetch(/*[[@{/chat/upload}]]*/ '/chat/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const fileMessage = {
                        messageType: data.messageType,
                        fileUrl: data.fileUrl,
                        fileName: data.fileName,
                    };
                    websocket.send(JSON.stringify(fileMessage));
                    cancelFile();
                } else {
                    alert('파일 업로드 실패: ' + data.message);
                }
            })
            .catch(error => {
                 console.error('File upload error:', error);
                 alert('파일 업로드 중 오류가 발생했습니다.');
            });
        }
        
        function cancelFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').style.display = 'none';
        }
        
        function addSystemMessage(content) {
            const chatArea = document.getElementById('chatArea');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'system-message';
            msgDiv.textContent = content;
            chatArea.appendChild(msgDiv);
            scrollToBottom();
        }

        function displayMessage(msg) {
            const chatArea = document.getElementById('chatArea');
            const isMyMessage = msg.userNo === currentUserNo;
            const timestamp = msg.timestamp || new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

            const row = document.createElement('div');
            row.className = isMyMessage ? 'message-row my-message' : 'message-row other-message';

            const content = document.createElement('div');
            content.className = 'message-content';

            if (!isMyMessage) {
                const sender = document.createElement('div');
                sender.className = 'sender-name';
                sender.textContent = msg.userName;
                content.appendChild(sender);
            }

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            let contentHtml = '';
            if (msg.messageType === 'image') {
                contentHtml = `<img src="${msg.fileUrl}" alt="${msg.fileName}" style="max-width: 200px; border-radius: 5px;">`;
            } else if (msg.messageType === 'video' || msg.messageType === 'audio' || msg.messageType === 'file') {
                contentHtml = `<a href="${msg.fileUrl}" download="${msg.fileName}" class="text-decoration-none">${msg.fileName}</a>`;
            } else {
                contentHtml = msg.messageContent;
            }
            bubble.innerHTML = contentHtml;
            content.appendChild(bubble);

            const info = document.createElement('div');
            info.className = 'message-info';
            info.textContent = timestamp;

            row.appendChild(content);
            row.appendChild(info);
            chatArea.appendChild(row);
            scrollToBottom();
        }
        
        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        /*]]>*/
    </script>
</body>
</html>