<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8" />
<title>ìŠµê´€ ë“±ë¡</title>
<style>
  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f3f7;
    margin: 0; padding: 50px 20px;
    display: flex; justify-content: center;
    min-height: 100vh;
    color: #333;
  }
  form {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    padding: 36px 48px;
    max-width: 720px;
    width: 100%;
    box-sizing: border-box;
  }
  h2 {
    text-align: center;
    margin-bottom: 36px;
    font-weight: 700;
    font-size: 1.8rem;
    color: #1a202c;
    letter-spacing: -0.02em;
  }
  form > div {
    margin-bottom: 24px;
  }
  label {
    display: inline-block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #4a5568;
    cursor: pointer;
    user-select: none;
  }
  input[type="text"],
  input[type="number"],
  input[type="time"],
  select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1.8px solid #cbd5e1;
    font-size: 1rem;
    transition: border-color 0.25s ease;
    box-sizing: border-box;
    outline-offset: 2px;
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="time"]:focus,
  select:focus {
    border-color: #4299e1;
    box-shadow: 0 0 6px #90cdf4;
  }
  input[type="checkbox"],
  input[type="radio"] {
    margin-right: 8px;
    width: 18px;
    height: 18px;
    vertical-align: middle;
    cursor: pointer;
  }
  #weeklyOptionSelector label,
  #weekDaysIntervalSection label,
  #weekDaysNthSection label,
  #nthWeekSection label {
    font-weight: 500;
    color: #2d3748;
    cursor: pointer;
    user-select: none;
    margin-right: 16px;
    margin-bottom: 10px;
    display: inline-flex;
    align-items: center;
    font-size: 0.95rem;
  }
  .option-group strong {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: #2c5282;
    font-size: 1.05rem;
  }
  .form-row {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-top: 10px;
  }
  button {
    width: 100%;
    background-color: #2b6cb0;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 14px 0;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s ease;
    user-select: none;
  }
  button:hover {
    background-color: #2c5282;
  }
  #calendarHeaderContainer {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 18px;
    margin: 28px 0 12px;
  }
  #calendarHeader {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2a4365;
    min-width: 150px;
    text-align: center;
    user-select: none;
  }
  #prevMonthBtn,
  #nextMonthBtn {
    width: 10%;
    background: #e2e8f0;
    border: none;
    padding: 8px 14px;
    border-radius: 10px;
    font-weight: 600;
    color: #2a4365;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  #prevMonthBtn:hover,
  #nextMonthBtn:hover {
    background-color: #cbd5e1;
  }
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    width: 100%;
    min-height: 380px;
    box-sizing: border-box;
  }
  .day {
    background: #fff;
    border: 1.5px solid #cbd5e1;
    border-radius: 12px;
    text-align: center;
    padding: 8px 6px;
    height: 66px;
    position: relative;
    font-size: 0.9rem;
    color: #2d3748;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 500;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }
  .day.header {
    font-weight: 700;
    background: #e9f0fc;
    border: none;
    color: #4a5568;
    user-select: none;
  }
  .day.highlight {
    background-color: #bee3f8;
    border-color: #4299e1;
    color: #1a365d;
    font-weight: 700;
  }
  .day.today {
    border: 2.5px solid #3182ce;
    color: #3182ce;
    font-weight: 700;
    box-shadow: 0 0 6px #90cdf4;
    background-color: #dbeafe;
  }
  .timeLabel {
    font-size: 0.75rem;
    color: #2c5282;
    position: absolute;
    bottom: 6px;
    right: 6px;
    font-weight: 600;
  }
  .checkbox-group label {
    display: inline-block;
    margin-right: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    font-weight: 500;
    color: #2d3748;
  }
  @media (max-width: 768px) {
    body {
      padding: 30px 10px;
    }
    form {
      padding: 28px 20px;
      max-width: 100%;
    }
    input[type="text"],
    input[type="number"],
    select,
    input[type="time"] {
      width: 100%;
    }
    .form-row {
      flex-direction: column;
      align-items: flex-start;
    }
    #calendarHeaderContainer {
      flex-direction: column;
      gap: 12px;
    }
    #prevMonthBtn,
    #nextMonthBtn {
      width: 100%;
      max-width: 200px;
    }
    #calendar {
      min-height: 320px;
    }
  }
  input[type="number"],
  span {
    vertical-align: middle;
  }
  .flex-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  span {
    line-height: 1.4;
  }
</style>
</head>

<body>

<form id="goalForm" th:object="${habit}" th:action="@{/habit/add}" method="post" autocomplete="off" >
  <h2>ìŠµê´€ ë“±ë¡</h2>

  <div>
    <label for="goal">ëª©í‘œ ì„ íƒ</label>
    <select name="goalNo" id="goal" required>
      <option value="" disabled selected>ëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      <option th:each="g : ${goalList}" th:value="${g.goalNo}" th:text="${g.title}"></option>
    </select>
  </div>

  <div>
    <label for="habitCategory">ìŠµê´€ ìœ í˜•</label>
    <select id="habitCategory" name="habitCategory" required>
      <option value="" disabled selected>ìœ í˜• ì„ íƒ</option>
      <option value="build">ëŠ˜ë¦´ ìŠµê´€ (ì˜ˆ: ê³µë¶€/ìš´ë™/ìê¸°ê³„ë°œ ë“±)</option>
      <option value="reduce">ì¤„ì¼ ìŠµê´€ (ì˜ˆ: ê²Œì„/TV/ìŒì£¼/ì•¼ì‹ ë“±)</option>
    </select>
  </div>

  <div>
    <label for="what">1ï¸âƒ£ ëª©í‘œë¥¼ ìœ„í•´ ë¬´ì—‡ì„ ì–¼ë§Œí¼ í•  ê±´ê°€ìš”?</label>
    <div class="example">ì˜ˆ: ì˜ë‹¨ì–´ 30ê°œ ì´ìƒ ì™¸ìš°ê¸° / ê²Œì„ 30ë¶„ë§Œ í•˜ê¸° / ì•„ì¹¨ 7ì‹œì— ì¼ì–´ë‚˜ê¸°</div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
      <input type="text" id="what" name="what" placeholder="ì˜ˆ: ì˜ë‹¨ì–´" style="flex: 3;" required aria-describedby="amountError" />
      <input type="number" id="amount" name="amount" placeholder="ì˜ˆ: 30" style="flex: 1;" required min="1"
        oninput="validateAmount()" inputmode="numeric" pattern="\d*" aria-describedby="amountError" />
      <input type="text" id="unit" name="unit" placeholder="ì˜ˆ: ê°œ" style="flex: 1;" required />
      <span id="unitSuffix" style="min-width: 30px; font-weight: 600; user-select: none;"></span>
      <input type="text" id="action" name="action" placeholder="ì˜ˆ: ì™¸ìš°ê¸°" style="flex: 2;" required />
    </div>
    <div id="amountError" class="example" style="color: red;" aria-live="polite" aria-atomic="true"></div>
  </div>

  <div>
    <label for="feasibilityLevel">2ï¸âƒ£ ì´ ëª©í‘œê°€ ì–¼ë§ˆë‚˜ ì‹¤í˜„ ê°€ëŠ¥í•˜ë‹¤ê³  ëŠê»´ì§€ë‚˜ìš”?</label>
    <select id="feasibilityLevel" name="feasibilityLevel" required>
      <option value="">-- ì„ íƒ --</option>
      <option value="high">ì¶©ë¶„íˆ ê°€ëŠ¥í•´ìš” (ìƒ)</option>
      <option value="medium">ì¡°ê¸ˆ ë¶€ë‹´ë¼ìš” (ì¤‘)</option>
      <option value="low">ë§ì´ ì–´ë ¤ì›Œìš” (í•˜)</option>
    </select>
    <div id="suggestionMessage" class="example" aria-live="polite" aria-atomic="true"></div>
  </div>

  <div>
    <label for="repeatType">3ï¸âƒ£ ë°˜ë³µ ìœ í˜•</label>
    <select name="repeat.repeatType" id="repeatType">
      <option value="DAILY">ë§¤ì¼</option>
      <option value="WEEKLY">ë§¤ì£¼</option>
      <option value="WEEKLY_COUNT">ì£¼ NíšŒ</option>
      <option value="MONTHLY_COUNT">ì›” NíšŒ</option>
    </select>
  </div>

  <div id="weeklyOptionSelector" style="display: none;">
    <fieldset>
      <legend class="example" style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">ì£¼ê°„ ë°˜ë³µ ì˜µì…˜</legend>
      <label for="weeklyOptionInterval"><input type="radio" name="weeklyOption" value="interval"
          id="weeklyOptionInterval" checked> Nì£¼ë§ˆë‹¤ ë°˜ë³µ</label>
      <label for="weeklyOptionNth"><input type="radio" name="weeklyOption" value="nth" id="weeklyOptionNth"> Nì§¸ì£¼ë§ˆë‹¤</label>
    </fieldset>
  </div>

  <div id="intervalSection" style="display: none;">
    <label for="repeatInterval">ë°˜ë³µ ê°„ê²©</label>
    <input type="number" name="repeat.interval" id="repeatInterval" min="1" value="1" inputmode="numeric" pattern="\d*"
      aria-describedby="intervalUnit" />
    <span id="intervalUnit">ì¼ë§ˆë‹¤</span>
  </div>

  <div id="repeatFrequencySection" style="display: none;">
    <label for="repeatFrequencyCount">ë°˜ë³µ íšŸìˆ˜</label>
    <span id="frequencyUnitText">ì£¼</span>
    <input type="number" name="repeat.frequencyCount" id="repeatFrequencyCount" min="1" max="365" value="1"
      inputmode="numeric" pattern="\d*" />
    <span>íšŒ</span>
  </div>

  <div id="nthWeekSection" style="display: none;" aria-label="Nì§¸ì£¼ ì²´í¬ë°•ìŠ¤ ê·¸ë£¹">
    <legend class="example" style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">í•´ë‹¹ ì£¼ì°¨ ì„ íƒ</legend>
    <label for="nthWeek1"><input type="checkbox" id="nthWeek1" name="repeat.nthWeeks" value="1">1ì§¸ì£¼</label>
    <label for="nthWeek2"><input type="checkbox" id="nthWeek2" name="repeat.nthWeeks" value="2">2ì§¸ì£¼</label>
    <label for="nthWeek3"><input type="checkbox" id="nthWeek3" name="repeat.nthWeeks" value="3">3ì§¸ì£¼</label>
    <label for="nthWeek4"><input type="checkbox" id="nthWeek4" name="repeat.nthWeeks" value="4">4ì§¸ì£¼</label>
    <label for="nthWeekLast"><input type="checkbox" id="nthWeekLast" name="repeat.nthWeeks" value="LAST">ë§ˆì§€ë§‰</label>
  </div>

  <div id="weekDaysSection" style="display: none;" aria-label="ë°˜ë³µ ìš”ì¼ ì„ íƒ ê·¸ë£¹">
    <div id="weekDaysIntervalSection" aria-label="Nì£¼ë§ˆë‹¤ Nìš”ì¼ ìš”ì¼ ì„ íƒ">
      <div><strong>Nì£¼ë§ˆë‹¤ Nìš”ì¼</strong></div>
      <label for="weekdayIntervalWeekdays"><input type="checkbox" id="weekdayIntervalWeekdays" onclick="selectWeekDays('weekdays', this.checked)">í‰ì¼</label>
      <label for="weekdayIntervalWeekends"><input type="checkbox" id="weekdayIntervalWeekends" onclick="selectWeekDays('weekends', this.checked)">ì£¼ë§</label><br>
      <label for="intervalMON"><input type="checkbox" id="intervalMON" name="repeat.weekDaysInterval" value="MON" class="weekday-interval">ì›”</label>
      <label for="intervalTUE"><input type="checkbox" id="intervalTUE" name="repeat.weekDaysInterval" value="TUE" class="weekday-interval">í™”</label>
      <label for="intervalWED"><input type="checkbox" id="intervalWED" name="repeat.weekDaysInterval" value="WED" class="weekday-interval">ìˆ˜</label>
      <label for="intervalTHU"><input type="checkbox" id="intervalTHU" name="repeat.weekDaysInterval" value="THU" class="weekday-interval">ëª©</label>
      <label for="intervalFRI"><input type="checkbox" id="intervalFRI" name="repeat.weekDaysInterval" value="FRI" class="weekday-interval">ê¸ˆ</label>
      <label for="intervalSAT"><input type="checkbox" id="intervalSAT" name="repeat.weekDaysInterval" value="SAT" class="weekend-interval">í† </label>
      <label for="intervalSUN"><input type="checkbox" id="intervalSUN" name="repeat.weekDaysInterval" value="SUN" class="weekend-interval">ì¼</label>
    </div>

    <div id="weekDaysNthSection" aria-label="Nì§¸ì£¼ë§ˆë‹¤ Nìš”ì¼ ìš”ì¼ ì„ íƒ">
      <div><strong>Nì§¸ì£¼ë§ˆë‹¤ Nìš”ì¼</strong></div>
      <label for="nthWeekdays"><input type="checkbox" id="nthWeekdays" onclick="selectNthWeekDays('weekday-nth', this.checked)">í‰ì¼</label>
      <label for="nthWeekends"><input type="checkbox" id="nthWeekends" onclick="selectNthWeekDays('weekend-nth', this.checked)">ì£¼ë§</label><br>
      <label for="nthMON"><input type="checkbox" id="nthMON" name="repeat.weekDays" value="MON" class="weekday-nth">ì›”</label>
      <label for="nthTUE"><input type="checkbox" id="nthTUE" name="repeat.weekDays" value="TUE" class="weekday-nth">í™”</label>
      <label for="nthWED"><input type="checkbox" id="nthWED" name="repeat.weekDays" value="WED" class="weekday-nth">ìˆ˜</label>
      <label for="nthTHU"><input type="checkbox" id="nthTHU" name="repeat.weekDays" value="THU" class="weekday-nth">ëª©</label>
      <label for="nthFRI"><input type="checkbox" id="nthFRI" name="repeat.weekDays" value="FRI" class="weekday-nth">ê¸ˆ</label>
      <label for="nthSAT"><input type="checkbox" id="nthSAT" name="repeat.weekDays" value="SAT" class="weekend-nth">í† </label>
      <label for="nthSUN"><input type="checkbox" id="nthSUN" name="repeat.weekDays" value="SUN" class="weekend-nth">ì¼</label>
    </div>
  </div>

  <div id="timeOptionSection" style="display: none;">
    <div>
      <label for="allDay">í•˜ë£¨ ì¢…ì¼</label>
      <input type="checkbox" name="repeat.allDay" id="allDay" checked>
    </div>
    <div id="timeSection">
      <label for="repeatTime">ì‹œê°„</label>
      <input type="time" name="repeat.repeatTime" id="repeatTime">
    </div>
  </div>

  <button type="submit" aria-label="ìŠµê´€ ë“±ë¡ í¼ ì œì¶œ">ë“±ë¡</button>
</form>

<form th:action="@{/habit/add}" method="post" autocomplete="off">
  <br>
  <div class="right-section">
    <div id="calendarHeaderContainer">
      <button type="button" id="prevMonthBtn" aria-label="ì´ì „ë‹¬">&lt;</button>
      <button type="button" id="nextMonthBtn" aria-label="ë‹¤ìŒë‹¬">&gt;</button><br><br>
      <span id="calendarHeader" role="heading" aria-level="2"></span>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>
</form>

<script>
  // --- ìœ í‹¸ í•¨ìˆ˜ë“¤ ---

  const weekdayMap = { SUN: 0, MON: 1, TUE: 2, WED: 3, THU: 4, FRI: 5, SAT: 6 };
  const unitMap = {
    DAILY: "ì¼",
    WEEKLY: "ì£¼",
    WEEKLY_COUNT: "ì£¼",
    MONTHLY_COUNT: "ì›”"
  };

  let calendarYear, calendarMonth;

  // ë‹¨ìœ„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  function updateUnitSuffix() {
    const category = document.getElementById('habitCategory').value;
    const suffixSpan = document.getElementById('unitSuffix');
    suffixSpan.textContent = category === 'build' ? 'ì´ìƒ' : category === 'reduce' ? 'ë§Œ' : '';
  }

  function updateIntervalUnit() {
    const type = document.getElementById("repeatType").value;
    const intervalInput = document.querySelector("input[name='repeat.interval']");
    const unitElement = document.getElementById("intervalUnit");
    const interval = parseInt(intervalInput.value, 10) || 1;
    const unitText = unitMap[type];
    unitElement.innerText = unitText ? (interval === 1 ? `ë§¤${unitText}` : `${interval}${unitText}ë§ˆë‹¤`) : "";
  }

  // ë°˜ë³µ ìœ í˜• ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
  function onRepeatTypeChange() {
    const type = document.getElementById("repeatType").value;
    const weeklyOptions = document.getElementsByName("weeklyOption");
    let weeklyOption = "interval";

    for (const opt of weeklyOptions)
      if (opt.checked) {
        weeklyOption = opt.value;
        break;
      }

    if (type !== "WEEKLY") {
      document.getElementById("weeklyOptionSelector").style.display = "none";
      weeklyOptions.forEach(opt => (opt.checked = false));
      weeklyOptions[0].checked = true;
      weeklyOption = "interval";
    } else {
      document.getElementById("weeklyOptionSelector").style.display = "block";
    }

    document.getElementById("weekDaysSection").style.display = type === "WEEKLY" ? "block" : "none";
    document.getElementById("nthWeekSection").style.display = weeklyOption === "nth" ? "block" : "none";

    const showInterval = (type === "DAILY") || (type === "WEEKLY" && weeklyOption === "interval");
    document.getElementById("intervalSection").style.display = showInterval ? "block" : "none";

    const freqSection = document.getElementById("repeatFrequencySection");
    freqSection.style.display = (type === "WEEKLY_COUNT" || type === "MONTHLY_COUNT") ? "block" : "none";
    document.getElementById("frequencyUnitText").innerText = unitMap[type] || "";

    document.getElementById("timeOptionSection").style.display = (type === "DAILY" || type === "WEEKLY") ? "block" : "none";

    if (type === "WEEKLY") {
      document.getElementById("weekDaysIntervalSection").style.display = weeklyOption === "interval" ? "block" : "none";
      document.getElementById("weekDaysNthSection").style.display = weeklyOption === "nth" ? "block" : "none";
    } else {
      document.getElementById("weekDaysIntervalSection").style.display = "none";
      document.getElementById("weekDaysNthSection").style.display = "none";
    }

    updateIntervalUnit();
    updateTimeVisibility();

    const calendarVisible = (type === "DAILY" || type === "WEEKLY");
    document.getElementById("calendar").style.display = calendarVisible ? "grid" : "none";
    document.getElementById("calendarHeaderContainer").style.display = calendarVisible ? "block" : "none";

    renderCalendar();
  }

  // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ì‹œ UI ì²˜ë¦¬
  function onWeeklyOptionChange() {
    const type = document.getElementById("repeatType").value;
    const selected = document.querySelector("input[name='weeklyOption']:checked")?.value || "interval";

    document.getElementById("weekDaysSection").style.display = "block";
    document.getElementById("nthWeekSection").style.display = selected === "nth" ? "block" : "none";

    document.getElementById("weekDaysIntervalSection").style.display = selected === "interval" ? "block" : "none";
    document.getElementById("weekDaysNthSection").style.display = selected === "nth" ? "block" : "none";

    const showInterval = (type === "DAILY") || (type === "WEEKLY" && selected === "interval");
    document.getElementById("intervalSection").style.display = showInterval ? "block" : "none";

    renderCalendar();
  }

  // ì‹œê°„ ì˜µì…˜ í‘œì‹œ í† ê¸€
  function updateTimeVisibility() {
    const allDay = document.getElementById("allDay").checked;
    document.getElementById("timeSection").style.display = allDay ? "none" : "block";
  }

  function selectWeekDays(group, checked) {
    const className = group === 'weekdays' ? 'weekday-interval' : 'weekend-interval';
    document.querySelectorAll(`.${className}`).forEach(cb => cb.checked = checked);
    renderCalendar();
  }

  function selectNthWeekDays(group, checked) {
    const className = group === 'weekday-nth' ? 'weekday-nth' : 'weekend-nth';
    document.querySelectorAll(`.${className}`).forEach(cb => cb.checked = checked);
    renderCalendar();
  }

  // Në²ˆì§¸ ì£¼ ê³„ì‚° (í•œêµ­ ê¸°ì¤€)
  function getKoreanWeekIndex(date) {
    const first = new Date(date.getFullYear(), date.getMonth(), 1);
    const firstMondayOffset = (first.getDay() === 0) ? 6 : first.getDay() - 1;
    const dayOffset = date.getDate() + firstMondayOffset - 1;
    return Math.floor(dayOffset / 7) + 1;
  }

  // ë§ˆì§€ë§‰ ì£¼ ì—¬ë¶€ í™•ì¸
  function isLastWeekOfMonth(date) {
    const nextWeek = new Date(date);
    nextWeek.setDate(nextWeek.getDate() + 7);
    return nextWeek.getMonth() !== date.getMonth();
  }

  // ë‹¬ë ¥ ë Œë”ë§
  function renderCalendar() {
    const calendar = document.getElementById("calendar");
    calendar.innerHTML = "";

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
    const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();

    const repeatType = document.getElementById("repeatType").value;
    const allDay = document.getElementById("allDay").checked;
    const startTime = document.querySelector("input[name='repeat.repeatTime']")?.value || "";
    const interval = parseInt(document.querySelector("input[name='repeat.interval']")?.value || "1", 10);
    const weeklyOption = document.querySelector("input[name='weeklyOption']:checked")?.value || "interval";

    const checkedDaysInterval = Array.from(document.querySelectorAll("input[name='repeat.weekDaysInterval']:checked"))
      .map(cb => weekdayMap[cb.value]);
    const checkedDaysNth = Array.from(document.querySelectorAll("input[name='repeat.weekDays']:checked"))
      .map(cb => weekdayMap[cb.value]);

    const nthWeeks = Array.from(document.querySelectorAll("input[name='repeat.nthWeeks']:checked"))
      .map(cb => cb.value);

    const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    weekdays.forEach(dayName => {
      const headerDiv = document.createElement("div");
      headerDiv.className = "day header";
      headerDiv.textContent = dayName;
      calendar.appendChild(headerDiv);
    });

    document.getElementById("calendarHeader").innerText = `${calendarYear}ë…„ ${calendarMonth + 1}ì›”`;

    // ì²« ì£¼ ê³µë°±
    for (let i = 0; i < firstDay; i++) {
      calendar.innerHTML += `<div class="day"></div>`;
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const currentDate = new Date(calendarYear, calendarMonth, day);
      const currentMidnight = new Date(currentDate);
      currentMidnight.setHours(0, 0, 0, 0);
      const dayOfWeek = currentDate.getDay();
      const isToday = currentMidnight.getTime() === today.getTime();
      let highlight = false;

      if (repeatType === "DAILY") {
        const diffDays = Math.floor((currentMidnight - today) / (1000 * 60 * 60 * 24));
        highlight = diffDays >= 0 && diffDays % interval === 0;
      }

      if (repeatType === "WEEKLY") {
        if (weeklyOption === "interval") {
          const startDate = new Date();
          startDate.setHours(0, 0, 0, 0);

          const startWeekMonday = new Date(startDate);
          const dayOfWeekStart = startDate.getDay();
          const offsetToMonday = (dayOfWeekStart === 0) ? -6 : 1 - dayOfWeekStart;
          startWeekMonday.setDate(startDate.getDate() + offsetToMonday);

          const currentWeekMonday = new Date(currentMidnight);
          const dayOfWeekCurrent = currentWeekMonday.getDay();
          const offsetCurrent = (dayOfWeekCurrent === 0) ? -6 : 1 - dayOfWeekCurrent;
          currentWeekMonday.setDate(currentMidnight.getDate() + offsetCurrent);

          const diffWeeks = Math.floor((currentWeekMonday - startWeekMonday) / (1000 * 60 * 60 * 24 * 7));

          if (diffWeeks >= 0 && diffWeeks % interval === 0 && checkedDaysInterval.includes(dayOfWeek)) {
            highlight = true;
          }
        }
        if (weeklyOption === "nth") {
          if (currentMidnight >= today && checkedDaysNth.includes(dayOfWeek)) {
            const weekIndex = getKoreanWeekIndex(currentDate);
            const isLast = isLastWeekOfMonth(currentDate);
            const matched = nthWeeks.includes(weekIndex.toString()) || (isLast && nthWeeks.includes("LAST"));
            if (matched) highlight = true;
          }
        }
      }

      const timeText = (!allDay && highlight) ? `<div class="timeLabel">${startTime}</div>` : "";

      calendar.innerHTML += `
        <div class="day ${highlight ? "highlight" : ""} ${isToday ? "today" : ""}">
          ${day}
          ${timeText}
        </div>
      `;
    }
  }

  // ì›” ë³€ê²½ í•¨ìˆ˜
  function goToPrevMonth() {
    if (calendarMonth === 0) {
      calendarMonth = 11;
      calendarYear--;
    } else {
      calendarMonth--;
    }
    renderCalendar();
  }

  function goToNextMonth() {
    if (calendarMonth === 11) {
      calendarMonth = 0;
      calendarYear++;
    } else {
      calendarMonth++;
    }
    renderCalendar();
  }

  // ê¸ˆì•¡ ìœ íš¨ì„± ê²€ì‚¬
  const amountInput = document.getElementById('amount');
  const amountError = document.getElementById('amountError');
  
  
  
  
  function validateAmount() {
    const value = amountInput.value.trim();

    // ë¹ˆì¹¸ì€ ì»¤ìŠ¤í…€ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì„¤ì • ì•ˆ í•¨ (ë¹ˆì¹¸ì€ requiredì—ì„œ ì²˜ë¦¬)
    if (value === "") {
      amountError.textContent = "";
      amountInput.setCustomValidity("");
      return;
    }

    if (!/^\d+$/.test(value) || parseInt(value) < 1) {
      amountError.textContent = "1 ì´ìƒì˜ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      amountInput.setCustomValidity("1 ì´ìƒì˜ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    } else {
      amountError.textContent = "";
      amountInput.setCustomValidity("");
    }
  }

  
  
  

  // ì¶”ì²œ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  function updateSuggestionMessage() {
    const level = document.getElementById('feasibilityLevel').value;
    const category = document.getElementById('habitCategory').value;
    const amount = parseInt(amountInput.value);
    const suggestionDiv = document.getElementById('suggestionMessage');

    if (!amount || amount < 1 || isNaN(amount) || !level || !category) {
      suggestionDiv.textContent = '';
      suggestionDiv.onclick = null;
      return;
    }

    let suggestion = '';
    let recommended = null;

    if (category === 'build') {
      if (level === 'medium' || level === 'low') {
        if (amount >= 30) {
          recommended = amount - (level === 'medium' ? 10 : 15);
          suggestion = `${recommended} ì •ë„ë¡œ ì¤„ì—¬ì„œ ë¶€ë‹´ ì—†ì´ ì‹œì‘í•´ë³´ì„¸ìš”. (í´ë¦­ ì‹œ ì ìš©)`;
        } else if (amount >= 10) {
          recommended = amount - (level === 'medium' ? 5 : 8);
          suggestion = `${recommended} ì •ë„ë¶€í„° ë¶€ë‹´ ì ê²Œ ì‹œì‘í•˜ì„¸ìš”! (í´ë¦­ ì‹œ ì ìš©)`;
        } else if (amount >= 5) {
          recommended = amount - (level === 'medium' ? 2 : 3);
          suggestion = `${recommended} ì •ë„ë¶€í„° ì‹œì‘í•´ ë³´ì„¸ìš” ğŸ˜Š (í´ë¦­ ì‹œ ì ìš©)`;
        } else {
          suggestion = 'ì§€ê¸ˆ ëª©í‘œë„ ì•„ì£¼ ì¢‹ì•„ìš”! ê³„ì† ë…¸ë ¥í•˜ì„¸ìš” ğŸ’ª';
        }
      } else {
        suggestion = 'ì¢‹ì•„ìš”! ì´ ì •ë„ë©´ ì¶©ë¶„íˆ í•´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ’ª';
      }
    } else if (category === 'reduce') {
      if (level === 'medium' || level === 'low') {
        if (amount <= 30) {
          recommended = amount + (level === 'medium' ? 10 : 15);
          suggestion = `${recommended} ì •ë„ë¡œ ë¬´ë¦¬í•˜ì§€ ë§ê³  ì²œì²œíˆ ì¤„ì—¬ë³´ì„¸ìš”. (í´ë¦­ ì‹œ ì ìš©)`;
        } else if (amount <= 60) {
          recommended = amount + (level === 'medium' ? 5 : 8);
          suggestion = `${recommended} ì •ë„ë¶€í„° ë¶€ë‹´ ì—†ì´ ì‹œì‘í•˜ì„¸ìš”! (í´ë¦­ ì‹œ ì ìš©)`;
        } else {
          recommended = amount + (level === 'medium' ? 2 : 3);
          suggestion = `${recommended} ì •ë„ë¡œ ì¡°ì ˆí•˜ë©° ì‹œì‘í•˜ëŠ” ê±¸ ê¶Œì¥í•©ë‹ˆë‹¤. ğŸ˜Š (í´ë¦­ ì‹œ ì ìš©)`;
        }
      } else {
        suggestion = 'ì¢‹ì•„ìš”! ì´ ì •ë„ë©´ ì¶©ë¶„íˆ ì‹¤ì²œ ê°€ëŠ¥í•  ê±°ì˜ˆìš” ğŸ’ª';
      }
    }

    suggestionDiv.textContent = suggestion;
    if (recommended !== null && recommended > 0) {
      suggestionDiv.style.cursor = 'pointer';
      suggestionDiv.onclick = function () {
        amountInput.value = recommended;
        amountInput.dispatchEvent(new Event('input'));
        this.textContent = 'ì¶”ì²œ íšŸìˆ˜ê°€ ì ìš©ëì–´ìš”!';
        this.style.cursor = 'default';
      };
    } else {
      suggestionDiv.onclick = null;
      suggestionDiv.style.cursor = 'default';
    }
  }

  // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ì„¤ì •
  window.addEventListener("DOMContentLoaded", () => {
    ['habitCategory', 'feasibilityLevel', 'amount'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', updateSuggestionMessage);
    });

    document.getElementById('habitCategory').addEventListener('change', () => {
      updateUnitSuffix();
      updateSuggestionMessage();
    });

    amountInput.addEventListener('input', () => {
      validateAmount();
      updateSuggestionMessage();
    });

    document.getElementById('feasibilityLevel').addEventListener('change', updateSuggestionMessage);

    document.getElementById("prevMonthBtn").addEventListener("click", goToPrevMonth);
    document.getElementById("nextMonthBtn").addEventListener("click", goToNextMonth);

    document.getElementById("repeatType").addEventListener("change", onRepeatTypeChange);

    document.querySelector("input[name='repeat.interval']").addEventListener("input", () => {
      updateIntervalUnit();
      renderCalendar();
    });

    document.querySelector("input[name='repeat.repeatTime']").addEventListener("input", renderCalendar);

    document.getElementById("allDay").addEventListener("change", () => {
      updateTimeVisibility();
      renderCalendar();
    });

    const inputs = [
      ...document.querySelectorAll("input[name='repeat.weekDaysInterval']"),
      ...document.querySelectorAll("input[name='repeat.weekDays']"),
      ...document.querySelectorAll("input[name='repeat.nthWeeks']"),
      ...document.querySelectorAll("input[name='weeklyOption']")
    ];
    inputs.forEach(input => input.addEventListener("change", () => {
      if (input.name === 'weeklyOption') onWeeklyOptionChange();
      else renderCalendar();
    }));

    validateAmount();
    updateUnitSuffix();
    updateSuggestionMessage();
    onRepeatTypeChange();

    const today = new Date();
    calendarYear = today.getFullYear();
    calendarMonth = today.getMonth();

    renderCalendar();

    // ì œì¶œ ì „ ê²€ì‚¬
    document.getElementById('goalForm').addEventListener('submit', e => {
      validateAmount();
      if (!amountInput.checkValidity()) {
        e.preventDefault();
        amountInput.focus();
      }
    });
  });
</script>

</body>

</html>
