<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8" />
<title>습관 등록</title>
<style>
  /* 기본 스타일 */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f3f7;
    margin: 0; padding: 50px 20px;
    display: flex; justify-content: center;
    min-height: 100vh;
    color: #333;
  }
  form {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    padding: 36px 48px;
    max-width: 720px;
    width: 100%;
    box-sizing: border-box;
  }
  h2 {
    text-align: center;
    margin-bottom: 36px;
    font-weight: 700;
    font-size: 1.8rem;
    color: #1a202c;
    letter-spacing: -0.02em;
  }
  form > div {
    margin-bottom: 24px;
  }
  label {
    display: inline-block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #4a5568;
    cursor: pointer;
    user-select: none;
  }
  input[type="text"],
  input[type="number"],
  input[type="time"],
  select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1.8px solid #cbd5e1;
    font-size: 1rem;
    transition: border-color 0.25s ease;
    box-sizing: border-box;
    outline-offset: 2px;
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="time"]:focus,
  select:focus {
    border-color: #4299e1;
    box-shadow: 0 0 6px #90cdf4;
  }
  input[type="checkbox"],
  input[type="radio"] {
    margin-right: 8px;
    width: 18px;
    height: 18px;
    vertical-align: middle;
    cursor: pointer;
  }
  #weeklyOptionSelector label,
  #weekDaysIntervalSection label,
  #weekDaysNthSection label,
  #nthWeekSection label {
    font-weight: 500;
    color: #2d3748;
    cursor: pointer;
    user-select: none;
    margin-right: 16px;
    margin-bottom: 10px;
    display: inline-flex;
    align-items: center;
    font-size: 0.95rem;
  }
  .option-group strong {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: #2c5282;
    font-size: 1.05rem;
  }
  .form-row {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-top: 10px;
  }
  button {
    width: 100%;
    background-color: #2b6cb0;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 14px 0;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s ease;
    user-select: none;
  }
  button:hover {
    background-color: #2c5282;
  }
  #calendarHeaderContainer {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 18px;
    margin: 28px 0 12px;
  }
  #calendarHeader {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2a4365;
    min-width: 150px;
    text-align: center;
    user-select: none;
  }
  #prevMonthBtn,
  #nextMonthBtn {
    width: 10%;
    background: #e2e8f0;
    border: none;
    padding: 8px 14px;
    border-radius: 10px;
    font-weight: 600;
    color: #2a4365;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  #prevMonthBtn:hover,
  #nextMonthBtn:hover {
    background-color: #cbd5e1;
  }
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    width: 100%;
    min-height: 380px;
    box-sizing: border-box;
  }
  .day {
    background: #fff;
    border: 1.5px solid #cbd5e1;
    border-radius: 12px;
    text-align: center;
    padding: 8px 6px;
    height: 66px;
    position: relative;
    font-size: 0.9rem;
    color: #2d3748;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 500;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }
  .day.header {
    font-weight: 700;
    background: #e9f0fc;
    border: none;
    color: #4a5568;
    user-select: none;
  }
  .day.highlight {
    background-color: #bee3f8;
    border-color: #4299e1;
    color: #1a365d;
    font-weight: 700;
  }
  .day.today {
    border: 2.5px solid #3182ce;
    color: #3182ce;
    font-weight: 700;
    box-shadow: 0 0 6px #90cdf4;
    background-color: #dbeafe;
  }
  .timeLabel {
    font-size: 0.75rem;
    color: #2c5282;
    position: absolute;
    bottom: 6px;
    right: 6px;
    font-weight: 600;
  }
  .checkbox-group label {
    display: inline-block;
    margin-right: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    font-weight: 500;
    color: #2d3748;
  }
  @media (max-width: 768px) {
    body {
      padding: 30px 10px;
    }
    form {
      padding: 28px 20px;
      max-width: 100%;
    }
    input[type="text"],
    input[type="number"],
    select,
    input[type="time"] {
      width: 100%;
    }
    .form-row {
      flex-direction: column;
      align-items: flex-start;
    }
    #calendarHeaderContainer {
      flex-direction: column;
      gap: 12px;
    }
    #prevMonthBtn,
    #nextMonthBtn {
      width: 100%;
      max-width: 200px;
    }
    #calendar {
      min-height: 320px;
    }
  }
  input[type="number"],
  span {
    vertical-align: middle;
  }
  .flex-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  span {
    line-height: 1.4;
  }
</style>
</head>

<body>

<form id="goalForm" th:object="${habit}" th:action="@{/habit/add}" method="post" autocomplete="off" >
  <h2>습관 등록</h2>

  <div>
    <label for="goal">목표 선택</label>
    <select name="goalNo" id="goal" required>
      <option value="" disabled selected>목표를 선택하세요</option>
      <option th:each="g : ${goalList}" th:value="${g.goalNo}" th:text="${g.title}"></option>
    </select>
  </div>

  <div>
    <label for="habitCategory">습관 유형</label>
    <select id="habitCategory" name="habitCategory" required>
      <option value="" disabled selected>유형 선택</option>
      <option value="build">늘릴 습관 (예: 공부/운동/자기계발 등)</option>
      <option value="reduce">줄일 습관 (예: 게임/TV/음주/야식 등)</option>
    </select>
  </div>

  <div>
    <label for="what">1️⃣ 목표를 위해 무엇을 얼만큼 할 건가요?</label>
    <div class="example">예: 영단어 30개 이상 외우기 / 게임 30분만 하기 / 아침 7시에 일어나기</div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
      <input type="text" id="what" name="what" placeholder="예: 영단어" style="flex: 3;" required aria-describedby="amountError" />
      <input type="number" id="amount" name="amount" placeholder="예: 30" style="flex: 1;" required min="1"
        oninput="validateAmount()" inputmode="numeric" pattern="\d*" aria-describedby="amountError" />
      <input type="text" id="unit" name="unit" placeholder="예: 개" style="flex: 1;" required />
      <span id="unitSuffix" style="min-width: 30px; font-weight: 600; user-select: none;"></span>
      <input type="text" id="action" name="action" placeholder="예: 외우기" style="flex: 2;" required />
    </div>
    <div id="amountError" class="example" style="color: red;" aria-live="polite" aria-atomic="true"></div>
  </div>

  <div>
    <label for="feasibilityLevel">2️⃣ 이 목표가 얼마나 실현 가능하다고 느껴지나요?</label>
    <select id="feasibilityLevel" name="feasibilityLevel" required>
      <option value="">-- 선택 --</option>
      <option value="high">충분히 가능해요 (상)</option>
      <option value="medium">조금 부담돼요 (중)</option>
      <option value="low">많이 어려워요 (하)</option>
    </select>
    <div id="suggestionMessage" class="example" aria-live="polite" aria-atomic="true"></div>
  </div>

  <div>
    <label for="repeatType">3️⃣ 반복 유형</label>
    <select name="repeat.repeatType" id="repeatType">
      <option value="DAILY">매일</option>
      <option value="WEEKLY">매주</option>
      <option value="WEEKLY_COUNT">주 N회</option>
      <option value="MONTHLY_COUNT">월 N회</option>
    </select>
  </div>

  <div id="weeklyOptionSelector" style="display: none;">
    <fieldset>
      <legend class="example" style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">주간 반복 옵션</legend>
      <label for="weeklyOptionInterval"><input type="radio" name="weeklyOption" value="interval"
          id="weeklyOptionInterval" checked> N주마다 반복</label>
      <label for="weeklyOptionNth"><input type="radio" name="weeklyOption" value="nth" id="weeklyOptionNth"> N째주마다</label>
    </fieldset>
  </div>

  <div id="intervalSection" style="display: none;">
    <label for="repeatInterval">반복 간격</label>
    <input type="number" name="repeat.interval" id="repeatInterval" min="1" value="1" inputmode="numeric" pattern="\d*"
      aria-describedby="intervalUnit" />
    <span id="intervalUnit">일마다</span>
  </div>

  <div id="repeatFrequencySection" style="display: none;">
    <label for="repeatFrequencyCount">반복 횟수</label>
    <span id="frequencyUnitText">주</span>
    <input type="number" name="repeat.frequencyCount" id="repeatFrequencyCount" min="1" max="365" value="1"
      inputmode="numeric" pattern="\d*" />
    <span>회</span>
  </div>

  <div id="nthWeekSection" style="display: none;" aria-label="N째주 체크박스 그룹">
    <legend class="example" style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">해당 주차 선택</legend>
    <label for="nthWeek1"><input type="checkbox" id="nthWeek1" name="repeat.nthWeeks" value="1">1째주</label>
    <label for="nthWeek2"><input type="checkbox" id="nthWeek2" name="repeat.nthWeeks" value="2">2째주</label>
    <label for="nthWeek3"><input type="checkbox" id="nthWeek3" name="repeat.nthWeeks" value="3">3째주</label>
    <label for="nthWeek4"><input type="checkbox" id="nthWeek4" name="repeat.nthWeeks" value="4">4째주</label>
    <label for="nthWeekLast"><input type="checkbox" id="nthWeekLast" name="repeat.nthWeeks" value="LAST">마지막</label>
  </div>

  <div id="weekDaysSection" style="display: none;" aria-label="반복 요일 선택 그룹">
    <div id="weekDaysIntervalSection" aria-label="N주마다 N요일 요일 선택">
      <div><strong>N주마다 N요일</strong></div>
      <label for="weekdayIntervalWeekdays"><input type="checkbox" id="weekdayIntervalWeekdays" onclick="selectWeekDays('weekdays', this.checked)">평일</label>
      <label for="weekdayIntervalWeekends"><input type="checkbox" id="weekdayIntervalWeekends" onclick="selectWeekDays('weekends', this.checked)">주말</label><br>
      <label for="intervalMON"><input type="checkbox" id="intervalMON" name="repeat.weekDaysInterval" value="MON" class="weekday-interval">월</label>
      <label for="intervalTUE"><input type="checkbox" id="intervalTUE" name="repeat.weekDaysInterval" value="TUE" class="weekday-interval">화</label>
      <label for="intervalWED"><input type="checkbox" id="intervalWED" name="repeat.weekDaysInterval" value="WED" class="weekday-interval">수</label>
      <label for="intervalTHU"><input type="checkbox" id="intervalTHU" name="repeat.weekDaysInterval" value="THU" class="weekday-interval">목</label>
      <label for="intervalFRI"><input type="checkbox" id="intervalFRI" name="repeat.weekDaysInterval" value="FRI" class="weekday-interval">금</label>
      <label for="intervalSAT"><input type="checkbox" id="intervalSAT" name="repeat.weekDaysInterval" value="SAT" class="weekend-interval">토</label>
      <label for="intervalSUN"><input type="checkbox" id="intervalSUN" name="repeat.weekDaysInterval" value="SUN" class="weekend-interval">일</label>
    </div>

    <div id="weekDaysNthSection" aria-label="N째주마다 N요일 요일 선택">
      <div><strong>N째주마다 N요일</strong></div>
      <label for="nthWeekdays"><input type="checkbox" id="nthWeekdays" onclick="selectNthWeekDays('weekday-nth', this.checked)">평일</label>
      <label for="nthWeekends"><input type="checkbox" id="nthWeekends" onclick="selectNthWeekDays('weekend-nth', this.checked)">주말</label><br>
      <label for="nthMON"><input type="checkbox" id="nthMON" name="repeat.weekDays" value="MON" class="weekday-nth">월</label>
      <label for="nthTUE"><input type="checkbox" id="nthTUE" name="repeat.weekDays" value="TUE" class="weekday-nth">화</label>
      <label for="nthWED"><input type="checkbox" id="nthWED" name="repeat.weekDays" value="WED" class="weekday-nth">수</label>
      <label for="nthTHU"><input type="checkbox" id="nthTHU" name="repeat.weekDays" value="THU" class="weekday-nth">목</label>
      <label for="nthFRI"><input type="checkbox" id="nthFRI" name="repeat.weekDays" value="FRI" class="weekday-nth">금</label>
      <label for="nthSAT"><input type="checkbox" id="nthSAT" name="repeat.weekDays" value="SAT" class="weekend-nth">토</label>
      <label for="nthSUN"><input type="checkbox" id="nthSUN" name="repeat.weekDays" value="SUN" class="weekend-nth">일</label>
    </div>
  </div>

  <div id="timeOptionSection" style="display: none;">
    <div>
      <label for="allDay">하루 종일</label>
      <input type="checkbox" name="repeat.allDay" id="allDay" checked>
    </div>
    <div id="timeSection">
      <label for="repeatTime">시간</label>
      <input type="time" name="repeat.repeatTime" id="repeatTime">
    </div>
  </div>

  <button type="submit" aria-label="습관 등록 폼 제출">등록</button>
</form>

<form th:action="@{/habit/add}" method="post" autocomplete="off">
  <br>
  <div class="right-section">
    <div id="calendarHeaderContainer">
      <button type="button" id="prevMonthBtn" aria-label="이전달">&lt;</button>
      <button type="button" id="nextMonthBtn" aria-label="다음달">&gt;</button><br><br>
      <span id="calendarHeader" role="heading" aria-level="2"></span>
    </div>
    <div id="calendar" class="calendar"></div>
  </div>
</form>

<script>
  // --- 유틸 함수들 ---

  const weekdayMap = { SUN: 0, MON: 1, TUE: 2, WED: 3, THU: 4, FRI: 5, SAT: 6 };
  const unitMap = {
    DAILY: "일",
    WEEKLY: "주",
    WEEKLY_COUNT: "주",
    MONTHLY_COUNT: "월"
  };

  let calendarYear, calendarMonth;

  // 단위 텍스트 업데이트
  function updateUnitSuffix() {
    const category = document.getElementById('habitCategory').value;
    const suffixSpan = document.getElementById('unitSuffix');
    suffixSpan.textContent = category === 'build' ? '이상' : category === 'reduce' ? '만' : '';
  }

  function updateIntervalUnit() {
    const type = document.getElementById("repeatType").value;
    const intervalInput = document.querySelector("input[name='repeat.interval']");
    const unitElement = document.getElementById("intervalUnit");
    const interval = parseInt(intervalInput.value, 10) || 1;
    const unitText = unitMap[type];
    unitElement.innerText = unitText ? (interval === 1 ? `매${unitText}` : `${interval}${unitText}마다`) : "";
  }

  // 반복 유형 변경 시 UI 업데이트
  function onRepeatTypeChange() {
    const type = document.getElementById("repeatType").value;
    const weeklyOptions = document.getElementsByName("weeklyOption");
    let weeklyOption = "interval";

    for (const opt of weeklyOptions)
      if (opt.checked) {
        weeklyOption = opt.value;
        break;
      }

    if (type !== "WEEKLY") {
      document.getElementById("weeklyOptionSelector").style.display = "none";
      weeklyOptions.forEach(opt => (opt.checked = false));
      weeklyOptions[0].checked = true;
      weeklyOption = "interval";
    } else {
      document.getElementById("weeklyOptionSelector").style.display = "block";
    }

    document.getElementById("weekDaysSection").style.display = type === "WEEKLY" ? "block" : "none";
    document.getElementById("nthWeekSection").style.display = weeklyOption === "nth" ? "block" : "none";

    const showInterval = (type === "DAILY") || (type === "WEEKLY" && weeklyOption === "interval");
    document.getElementById("intervalSection").style.display = showInterval ? "block" : "none";

    const freqSection = document.getElementById("repeatFrequencySection");
    freqSection.style.display = (type === "WEEKLY_COUNT" || type === "MONTHLY_COUNT") ? "block" : "none";
    document.getElementById("frequencyUnitText").innerText = unitMap[type] || "";

    document.getElementById("timeOptionSection").style.display = (type === "DAILY" || type === "WEEKLY") ? "block" : "none";

    if (type === "WEEKLY") {
      document.getElementById("weekDaysIntervalSection").style.display = weeklyOption === "interval" ? "block" : "none";
      document.getElementById("weekDaysNthSection").style.display = weeklyOption === "nth" ? "block" : "none";
    } else {
      document.getElementById("weekDaysIntervalSection").style.display = "none";
      document.getElementById("weekDaysNthSection").style.display = "none";
    }

    updateIntervalUnit();
    updateTimeVisibility();

    const calendarVisible = (type === "DAILY" || type === "WEEKLY");
    document.getElementById("calendar").style.display = calendarVisible ? "grid" : "none";
    document.getElementById("calendarHeaderContainer").style.display = calendarVisible ? "block" : "none";

    renderCalendar();
  }

  // 라디오 버튼 변경시 UI 처리
  function onWeeklyOptionChange() {
    const type = document.getElementById("repeatType").value;
    const selected = document.querySelector("input[name='weeklyOption']:checked")?.value || "interval";

    document.getElementById("weekDaysSection").style.display = "block";
    document.getElementById("nthWeekSection").style.display = selected === "nth" ? "block" : "none";

    document.getElementById("weekDaysIntervalSection").style.display = selected === "interval" ? "block" : "none";
    document.getElementById("weekDaysNthSection").style.display = selected === "nth" ? "block" : "none";

    const showInterval = (type === "DAILY") || (type === "WEEKLY" && selected === "interval");
    document.getElementById("intervalSection").style.display = showInterval ? "block" : "none";

    renderCalendar();
  }

  // 시간 옵션 표시 토글
  function updateTimeVisibility() {
    const allDay = document.getElementById("allDay").checked;
    document.getElementById("timeSection").style.display = allDay ? "none" : "block";
  }

  function selectWeekDays(group, checked) {
    const className = group === 'weekdays' ? 'weekday-interval' : 'weekend-interval';
    document.querySelectorAll(`.${className}`).forEach(cb => cb.checked = checked);
    renderCalendar();
  }

  function selectNthWeekDays(group, checked) {
    const className = group === 'weekday-nth' ? 'weekday-nth' : 'weekend-nth';
    document.querySelectorAll(`.${className}`).forEach(cb => cb.checked = checked);
    renderCalendar();
  }

  // N번째 주 계산 (한국 기준)
  function getKoreanWeekIndex(date) {
    const first = new Date(date.getFullYear(), date.getMonth(), 1);
    const firstMondayOffset = (first.getDay() === 0) ? 6 : first.getDay() - 1;
    const dayOffset = date.getDate() + firstMondayOffset - 1;
    return Math.floor(dayOffset / 7) + 1;
  }

  // 마지막 주 여부 확인
  function isLastWeekOfMonth(date) {
    const nextWeek = new Date(date);
    nextWeek.setDate(nextWeek.getDate() + 7);
    return nextWeek.getMonth() !== date.getMonth();
  }

  // 달력 렌더링
  function renderCalendar() {
    const calendar = document.getElementById("calendar");
    calendar.innerHTML = "";

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
    const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();

    const repeatType = document.getElementById("repeatType").value;
    const allDay = document.getElementById("allDay").checked;
    const startTime = document.querySelector("input[name='repeat.repeatTime']")?.value || "";
    const interval = parseInt(document.querySelector("input[name='repeat.interval']")?.value || "1", 10);
    const weeklyOption = document.querySelector("input[name='weeklyOption']:checked")?.value || "interval";

    const checkedDaysInterval = Array.from(document.querySelectorAll("input[name='repeat.weekDaysInterval']:checked"))
      .map(cb => weekdayMap[cb.value]);
    const checkedDaysNth = Array.from(document.querySelectorAll("input[name='repeat.weekDays']:checked"))
      .map(cb => weekdayMap[cb.value]);

    const nthWeeks = Array.from(document.querySelectorAll("input[name='repeat.nthWeeks']:checked"))
      .map(cb => cb.value);

    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    weekdays.forEach(dayName => {
      const headerDiv = document.createElement("div");
      headerDiv.className = "day header";
      headerDiv.textContent = dayName;
      calendar.appendChild(headerDiv);
    });

    document.getElementById("calendarHeader").innerText = `${calendarYear}년 ${calendarMonth + 1}월`;

    // 첫 주 공백
    for (let i = 0; i < firstDay; i++) {
      calendar.innerHTML += `<div class="day"></div>`;
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const currentDate = new Date(calendarYear, calendarMonth, day);
      const currentMidnight = new Date(currentDate);
      currentMidnight.setHours(0, 0, 0, 0);
      const dayOfWeek = currentDate.getDay();
      const isToday = currentMidnight.getTime() === today.getTime();
      let highlight = false;

      if (repeatType === "DAILY") {
        const diffDays = Math.floor((currentMidnight - today) / (1000 * 60 * 60 * 24));
        highlight = diffDays >= 0 && diffDays % interval === 0;
      }

      if (repeatType === "WEEKLY") {
        if (weeklyOption === "interval") {
          const startDate = new Date();
          startDate.setHours(0, 0, 0, 0);

          const startWeekMonday = new Date(startDate);
          const dayOfWeekStart = startDate.getDay();
          const offsetToMonday = (dayOfWeekStart === 0) ? -6 : 1 - dayOfWeekStart;
          startWeekMonday.setDate(startDate.getDate() + offsetToMonday);

          const currentWeekMonday = new Date(currentMidnight);
          const dayOfWeekCurrent = currentWeekMonday.getDay();
          const offsetCurrent = (dayOfWeekCurrent === 0) ? -6 : 1 - dayOfWeekCurrent;
          currentWeekMonday.setDate(currentMidnight.getDate() + offsetCurrent);

          const diffWeeks = Math.floor((currentWeekMonday - startWeekMonday) / (1000 * 60 * 60 * 24 * 7));

          if (diffWeeks >= 0 && diffWeeks % interval === 0 && checkedDaysInterval.includes(dayOfWeek)) {
            highlight = true;
          }
        }
        if (weeklyOption === "nth") {
          if (currentMidnight >= today && checkedDaysNth.includes(dayOfWeek)) {
            const weekIndex = getKoreanWeekIndex(currentDate);
            const isLast = isLastWeekOfMonth(currentDate);
            const matched = nthWeeks.includes(weekIndex.toString()) || (isLast && nthWeeks.includes("LAST"));
            if (matched) highlight = true;
          }
        }
      }

      const timeText = (!allDay && highlight) ? `<div class="timeLabel">${startTime}</div>` : "";

      calendar.innerHTML += `
        <div class="day ${highlight ? "highlight" : ""} ${isToday ? "today" : ""}">
          ${day}
          ${timeText}
        </div>
      `;
    }
  }

  // 월 변경 함수
  function goToPrevMonth() {
    if (calendarMonth === 0) {
      calendarMonth = 11;
      calendarYear--;
    } else {
      calendarMonth--;
    }
    renderCalendar();
  }

  function goToNextMonth() {
    if (calendarMonth === 11) {
      calendarMonth = 0;
      calendarYear++;
    } else {
      calendarMonth++;
    }
    renderCalendar();
  }

  // 금액 유효성 검사
  const amountInput = document.getElementById('amount');
  const amountError = document.getElementById('amountError');
  
  
  
  
  function validateAmount() {
    const value = amountInput.value.trim();

    // 빈칸은 커스텀 유효성 검사를 설정 안 함 (빈칸은 required에서 처리)
    if (value === "") {
      amountError.textContent = "";
      amountInput.setCustomValidity("");
      return;
    }

    if (!/^\d+$/.test(value) || parseInt(value) < 1) {
      amountError.textContent = "1 이상의 숫자만 입력해주세요.";
      amountInput.setCustomValidity("1 이상의 숫자만 입력해주세요.");
    } else {
      amountError.textContent = "";
      amountInput.setCustomValidity("");
    }
  }

  
  
  

  // 추천 메시지 업데이트
  function updateSuggestionMessage() {
    const level = document.getElementById('feasibilityLevel').value;
    const category = document.getElementById('habitCategory').value;
    const amount = parseInt(amountInput.value);
    const suggestionDiv = document.getElementById('suggestionMessage');

    if (!amount || amount < 1 || isNaN(amount) || !level || !category) {
      suggestionDiv.textContent = '';
      suggestionDiv.onclick = null;
      return;
    }

    let suggestion = '';
    let recommended = null;

    if (category === 'build') {
      if (level === 'medium' || level === 'low') {
        if (amount >= 30) {
          recommended = amount - (level === 'medium' ? 10 : 15);
          suggestion = `${recommended} 정도로 줄여서 부담 없이 시작해보세요. (클릭 시 적용)`;
        } else if (amount >= 10) {
          recommended = amount - (level === 'medium' ? 5 : 8);
          suggestion = `${recommended} 정도부터 부담 적게 시작하세요! (클릭 시 적용)`;
        } else if (amount >= 5) {
          recommended = amount - (level === 'medium' ? 2 : 3);
          suggestion = `${recommended} 정도부터 시작해 보세요 😊 (클릭 시 적용)`;
        } else {
          suggestion = '지금 목표도 아주 좋아요! 계속 노력하세요 💪';
        }
      } else {
        suggestion = '좋아요! 이 정도면 충분히 해낼 수 있습니다 💪';
      }
    } else if (category === 'reduce') {
      if (level === 'medium' || level === 'low') {
        if (amount <= 30) {
          recommended = amount + (level === 'medium' ? 10 : 15);
          suggestion = `${recommended} 정도로 무리하지 말고 천천히 줄여보세요. (클릭 시 적용)`;
        } else if (amount <= 60) {
          recommended = amount + (level === 'medium' ? 5 : 8);
          suggestion = `${recommended} 정도부터 부담 없이 시작하세요! (클릭 시 적용)`;
        } else {
          recommended = amount + (level === 'medium' ? 2 : 3);
          suggestion = `${recommended} 정도로 조절하며 시작하는 걸 권장합니다. 😊 (클릭 시 적용)`;
        }
      } else {
        suggestion = '좋아요! 이 정도면 충분히 실천 가능할 거예요 💪';
      }
    }

    suggestionDiv.textContent = suggestion;
    if (recommended !== null && recommended > 0) {
      suggestionDiv.style.cursor = 'pointer';
      suggestionDiv.onclick = function () {
        amountInput.value = recommended;
        amountInput.dispatchEvent(new Event('input'));
        this.textContent = '추천 횟수가 적용됐어요!';
        this.style.cursor = 'default';
      };
    } else {
      suggestionDiv.onclick = null;
      suggestionDiv.style.cursor = 'default';
    }
  }

  // 초기화 및 이벤트 설정
  window.addEventListener("DOMContentLoaded", () => {
    ['habitCategory', 'feasibilityLevel', 'amount'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', updateSuggestionMessage);
    });

    document.getElementById('habitCategory').addEventListener('change', () => {
      updateUnitSuffix();
      updateSuggestionMessage();
    });

    amountInput.addEventListener('input', () => {
      validateAmount();
      updateSuggestionMessage();
    });

    document.getElementById('feasibilityLevel').addEventListener('change', updateSuggestionMessage);

    document.getElementById("prevMonthBtn").addEventListener("click", goToPrevMonth);
    document.getElementById("nextMonthBtn").addEventListener("click", goToNextMonth);

    document.getElementById("repeatType").addEventListener("change", onRepeatTypeChange);

    document.querySelector("input[name='repeat.interval']").addEventListener("input", () => {
      updateIntervalUnit();
      renderCalendar();
    });

    document.querySelector("input[name='repeat.repeatTime']").addEventListener("input", renderCalendar);

    document.getElementById("allDay").addEventListener("change", () => {
      updateTimeVisibility();
      renderCalendar();
    });

    const inputs = [
      ...document.querySelectorAll("input[name='repeat.weekDaysInterval']"),
      ...document.querySelectorAll("input[name='repeat.weekDays']"),
      ...document.querySelectorAll("input[name='repeat.nthWeeks']"),
      ...document.querySelectorAll("input[name='weeklyOption']")
    ];
    inputs.forEach(input => input.addEventListener("change", () => {
      if (input.name === 'weeklyOption') onWeeklyOptionChange();
      else renderCalendar();
    }));

    validateAmount();
    updateUnitSuffix();
    updateSuggestionMessage();
    onRepeatTypeChange();

    const today = new Date();
    calendarYear = today.getFullYear();
    calendarMonth = today.getMonth();

    renderCalendar();

    // 제출 전 검사
    document.getElementById('goalForm').addEventListener('submit', e => {
      validateAmount();
      if (!amountInput.checkValidity()) {
        e.preventDefault();
        amountInput.focus();
      }
    });
  });
</script>

</body>

</html>
