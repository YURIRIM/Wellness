<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<title>ëª©í‘œ ìˆ˜ì •</title>
	<style>
		body {
			font-family: sans-serif;
			line-height: 1.6;
			padding: 2rem;
			max-width: 600px;
			margin: auto;
		}

		label {
			display: block;
			margin-top: 1.5rem;
			font-weight: bold;
		}

		input,
		select,
		textarea {
			width: 100%;
			padding: 0.6rem;
			margin-top: 0.4rem;
			box-sizing: border-box;
			border-radius: 6px;
			border: 1px solid #ccc;
		}

		.example {
			font-size: 0.9rem;
			color: #666;
			margin-top: 0.3rem;
		}

		button {
			margin-top: 2rem;
			padding: 0.8rem 1.2rem;
			background: #4CAF50;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
		}

		button:hover {
			background: #45a049;
		}

		form {
			background-color: #fff;
			border-radius: 16px;
			box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
			padding: 36px 48px;
			max-width: 720px;
			width: 100%;
			box-sizing: border-box;
		}

		.error {
			color: red;
			font-size: 0.9rem;
			margin-top: 0.4rem;
		}

		#deadlineTypeWrapper {
			display: flex;
			gap: 1.5rem;
			flex-wrap: wrap;
			align-items: center;
		}

		#deadlineTypeWrapper label {
			display: flex;
			align-items: center;
			cursor: pointer;
			user-select: none;
			gap: 0.4rem;
			font-weight: normal;
			color: #333;
			font-size: 1rem;
		}

		#deadlineTypeWrapper input[type="radio"] {
			width: 15px;
			height: 15px;
			cursor: pointer;
			margin: 0;
		}
	</style>

</head>

<body>
	<form id="goalForm" th:action="@{/habit/goal/update}" method="post">
		<h2>ğŸ¯ ëª©í‘œ ìˆ˜ì •</h2> <input type="hidden" name="goalNo" th:value="${goal.goalNo}" />
		<!-- hidden input for title --> <input type="hidden" id="title" name="title" />
		<label for="goalCategory">1ï¸âƒ£ ì–´ë–¤ ë¶„ì•¼ì˜ ëª©í‘œì¸ê°€ìš”?</label>
		<select id="goalCategory" name="goalCategory" required>
			<option value="">-- ì„ íƒ ì•ˆ í•¨ --</option>
			<option value="health" th:selected="${goal.goalCategory == 'health'}">ê±´ê°• / ìš´ë™</option>
			<option value="learning" th:selected="${goal.goalCategory == 'learning'}">í•™ìŠµ / ìê²©ì¦</option>
			<option value="career" th:selected="${goal.goalCategory == 'career'}">ì»¤ë¦¬ì–´ / ì—…ë¬´</option>
			<option value="finance" th:selected="${goal.goalCategory == 'finance'}">ì¬ë¬´ / ì ˆì•½</option>
			<option value="relationship" th:selected="${goal.goalCategory == 'relationship'}">ì¸ê°„ê´€ê³„ / ê°€ì¡±</option>
			<option value="hobby" th:selected="${goal.goalCategory == 'hobby'}">ì·¨ë¯¸ / ìê¸°ê³„ë°œ</option>
			<option value="daily" th:selected="${goal.goalCategory == 'daily'}">ìƒí™œ ìŠµê´€</option>
		</select>

		<label for="content">2ï¸âƒ£ ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?</label>
		<input type="text" id="content" name="content" placeholder="ì˜ˆ) ìš´ë™í•˜ê¸°" required th:value="${goal.content}" />

		<div class="example">ì˜ˆ: ìš´ë™í•˜ê¸° / í† ìµ ê³µë¶€ </div>
		<label for="whyGoal">3ï¸âƒ£ ì™œ ì´ ëª©í‘œë¥¼ ì´ë£¨ê³  ì‹¶ë‚˜ìš”?</label>
		<input type="text" id="whyGoal" name="whyGoal" placeholder="ì˜ˆ) ê±´ê°•í•œ ëª¸ì„ ë§Œë“¤ê³  ì‹¶ì–´ì„œ ë“±" required
			th:value="${goal.whyGoal}" />

		<div class="example">ì˜ˆ: ë” ê±´ê°•í•˜ê³  í™œê¸°ì°¬ ì‚¶ì„ ì‚´ê¸° ìœ„í•´ / ìœ í•™ì„ ìœ„í•´ í† ìµ ì ìˆ˜ê°€ í•„ìš”í•´ì„œ </div>
		<label>4ï¸âƒ£ ì–´ë–¤ ë³€í™”ë¥¼ ì›í•˜ë‚˜ìš”?</label>

		<div style="display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center;"> <input type="text" id="action"
				name="action" placeholder="ì˜ˆ: ì²´ì¤‘" style="flex: 2;" required th:value="${goal.action}" /> <input
				type="number" id="beforeState" name="beforeState" placeholder="í˜„ì¬ ìˆ˜ì¹˜" min="1" style="flex: 1;" required
				th:value="${goal.beforeState}" /> <span style="flex: 0; font-weight: bold;">â†’</span> <input
				type="number" id="afterState" name="afterState" placeholder="ëª©í‘œ ìˆ˜ì¹˜" min="1" style="flex: 1;" required
				th:value="${goal.afterState}" /> <input type="text" id="unit" name="unit" placeholder="ì˜ˆ: kg"
				style="flex: 1.5;" required th:value="${goal.unit}" /> </div>
		<div class="example">ì˜ˆ: ì²´ì¤‘ 60 â†’ 55 kg / í† ìµ ì ìˆ˜ 500 â†’ 800 ì  </div>
		<label>5ï¸âƒ£ ì–¸ì œê¹Œì§€ ì´ë£¨ê³  ì‹¶ë‚˜ìš”?</label>

		<div id="deadlineTypeWrapper"> <label> <input type="radio" name="deadlineType" value="relative"
					th:checked="${goal.deadlineType == 'relative'}" /> ê¸°ê°„ìœ¼ë¡œ ì„¤ì • </label> <label> <input type="radio"
					name="deadlineType" value="absolute" th:checked="${goal.deadlineType == 'absolute'}" /> íŠ¹ì • ë‚ ì§œë¡œ ì„¤ì •
			</label> </div>
		<div id="relativeDeadlineInputs" style="display:flex; gap: 0.5rem; align-items: center; margin-top: 0.4rem;"
			th:if="${goal.deadlineType == 'relative'}"> <input type="number" id="deadlineValue" name="deadlineValue"
				min="1" placeholder="ìˆ«ì ì…ë ¥ (ì˜ˆ: 3)" inputmode="numeric" pattern="[0-9]*"
				th:value="${goal.deadlineValue}" /> <select id="deadlineUnit" name="deadlineUnit">
				<option value="">ë‹¨ìœ„ ì„ íƒ</option>
				<option value="days" th:selected="${goal.deadlineUnit == 'days'}">ì¼</option>
				<option value="weeks" th:selected="${goal.deadlineUnit == 'weeks'}">ì£¼</option>
				<option value="months" th:selected="${goal.deadlineUnit == 'months'}">ê°œì›”</option>
				<option value="years" th:selected="${goal.deadlineUnit == 'years'}">ë…„</option>
			</select> </div>
		<div id="absoluteDeadlineInput" style="margin-top: 0.8rem;" th:if="${goal.deadlineType == 'absolute'}"> <input
				type="text" id="customDateInput" name="customDateInput" placeholder="YYYYMMDD ì…ë ¥" inputmode="numeric"
				pattern="\d*" maxlength="8" th:value="${#dates.format(goal.endDate, 'yyyyMMdd')}" /> </div> <input
			type="hidden" id="endDate" name="endDate" th:value="${#dates.format(goal.endDate, 'yyyy-MM-dd')}" />
		<div id="endDateDisplay" style="margin-top: 0.5rem; font-size: 0.9rem; color: #333;"></div>
		<div id="deadlineError" class="error"></div>
		<button type="submit">ëª©í‘œ ìˆ˜ì •í•˜ê¸°</button>

	</form> <br /> <a th:href="@{/habit/list}">ëª©ë¡ìœ¼ë¡œ</a> <a th:href="@{/habit/cal}">ìº˜ë¦°ë”</a> <a
		th:href="@{/habit/today}">ì˜¤ëŠ˜ì˜</a>
	<script> 
		(() => {
		  const relativeInputs = document.getElementById('relativeDeadlineInputs');
		  const absoluteInput = document.getElementById('absoluteDeadlineInput');
		  const radios = document.querySelectorAll('input[name="deadlineType"]');
		  const customDateInput = document.getElementById('customDateInput');
		  const deadlineValueInput = document.getElementById('deadlineValue');
		  const deadlineUnitSelect = document.getElementById('deadlineUnit');
		  const endDateHidden = document.getElementById('endDate');
		  const endDateDisplay = document.getElementById('endDateDisplay');
		  const deadlineError = document.getElementById('deadlineError');
		  const today = new Date();
		  const maxDate = new Date();
		  maxDate.setFullYear(today.getFullYear() + 20);

		  radios.forEach(radio => {
		    radio.addEventListener('change', () => {
		      if (radio.value === 'relative' && radio.checked) {
		        relativeInputs.style.display = 'flex';
		        absoluteInput.style.display = 'none';
		        customDateInput.value = '';
		        endDateDisplay.textContent = '';
		        endDateHidden.value = '';
		        deadlineError.textContent = '';
		      } else if (radio.value === 'absolute' && radio.checked) {
		        relativeInputs.style.display = 'none';
		        absoluteInput.style.display = 'block';
		        deadlineValueInput.value = '';
		        deadlineUnitSelect.value = '';
		        endDateDisplay.textContent = '';
		        endDateHidden.value = '';
		        deadlineError.textContent = '';
		      }
		    });
		  });

		  deadlineValueInput.addEventListener('input', () => {
		    deadlineValueInput.value = deadlineValueInput.value.replace(/[^0-9]/g, '');
		    customDateInput.value = '';
		    deadlineError.textContent = '';
		    updateDeadlineDate();
		  });

		  deadlineUnitSelect.addEventListener('change', () => {
		    customDateInput.value = '';
		    deadlineError.textContent = '';
		    updateDeadlineDate();
		  });

		  function updateDeadlineDate() {
		    deadlineError.textContent = '';
		    endDateDisplay.textContent = '';
		    endDateHidden.value = '';

		    const value = parseInt(deadlineValueInput.value);
		    const unit = deadlineUnitSelect.value;
		    if (!value || value < 1) {
		      if (deadlineValueInput.value !== '') deadlineError.textContent = 'âš ï¸ 1 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
		      return;
		    }
		    if (!unit) return;

		    const deadline = new Date(today.getTime());
		    switch (unit) {
		      case 'days':
		        deadline.setDate(deadline.getDate() + value);
		        break;
		      case 'weeks':
		        deadline.setDate(deadline.getDate() + value * 7);
		        break;
		      case 'months':
		        deadline.setMonth(deadline.getMonth() + value);
		        break;
		      case 'years':
		        if (value > 20) {
		          deadlineError.textContent = 'âš ï¸ ë„ˆë¬´ ë¨¼ ë¯¸ë˜ì…ë‹ˆë‹¤. 20ë…„ ì´ë‚´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
		          return;
		        }
		        deadline.setFullYear(deadline.getFullYear() + value);
		        break;
		    }
		    if (deadline > maxDate) {
		      deadlineError.textContent = 'âš ï¸ ëª©í‘œ ë§ˆê°ì¼ì€ ìµœëŒ€ 20ë…„ ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.';
		      return;
		    }

		    const formattedDate = deadline.toISOString().slice(0, 10);
		    endDateDisplay.textContent = `ğŸ‘‰ ì˜ˆìƒ ë§ˆê°ì¼: ${formattedDate}`;
		    endDateHidden.value = formattedDate;
		  }

		  customDateInput.addEventListener('keydown', e => {
		    const allowedKeys = ['0','1','2','3','4','5','6','7','8','9','Backspace','Delete','ArrowLeft','ArrowRight','Tab'];
		    if (!allowedKeys.includes(e.key)) e.preventDefault();
		  });

		  customDateInput.addEventListener('input', e => {
		    e.target.value = e.target.value.replace(/\D/g, '');
		    const raw = e.target.value.trim();
		    if (raw.length !== 8) {
		      endDateDisplay.textContent = '';
		      endDateHidden.value = '';
		      return;
		    }
		    const yyyy = raw.slice(0, 4), mm = raw.slice(4, 6), dd = raw.slice(6, 8);
		    const formatted = `${yyyy}-${mm}-${dd}`;
		    const parsedDate = new Date(formatted);
		    if (isNaN(parsedDate.getTime()) || formatted !== parsedDate.toISOString().slice(0, 10)) {
		      alert('âŒ ì˜¬ë°”ë¥¸ ë‚ ì§œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
		      e.target.value = '';
		      endDateDisplay.textContent = '';
		      endDateHidden.value = '';
		      return;
		    }
		    const todayZero = new Date(new Date().setHours(0, 0, 0, 0));
		    if (parsedDate < todayZero) {
		      alert('âŒ ê³¼ê±° ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
		      e.target.value = '';
		      endDateDisplay.textContent = '';
		      endDateHidden.value = '';
		      return;
		    }
		    if (parsedDate > maxDate) {
		      alert('âŒ ëª©í‘œ ë§ˆê°ì¼ì€ ìµœëŒ€ 20ë…„ ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
		      e.target.value = '';
		      endDateDisplay.textContent = '';
		      endDateHidden.value = '';
		      return;
		    }
		    deadlineValueInput.value = '';
		    deadlineUnitSelect.value = '';
		    deadlineError.textContent = '';
		    endDateDisplay.textContent = `ğŸ‘‰ ì˜ˆìƒ ë§ˆê°ì¼: ${formatted}`;
		    endDateHidden.value = formatted;
		  });

		  const beforeInput = document.getElementById('beforeState');
		  const afterInput = document.getElementById('afterState');

		  function validateBeforeAfter() {
		    const beforeVal = parseInt(beforeInput.value);
		    const afterVal = parseInt(afterInput.value);
		    let valid = true;

		    if (!beforeVal || beforeVal < 1) {
		      beforeInput.setCustomValidity('í˜„ì¬ ìƒíƒœëŠ” 1 ì´ìƒì˜ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
		      valid = false;
		    } else {
		      beforeInput.setCustomValidity('');
		    }

		    if (!afterVal || afterVal < 1) {
		      afterInput.setCustomValidity('ëª©í‘œ ìƒíƒœëŠ” 1 ì´ìƒì˜ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
		      valid = false;
		    } else {
		      afterInput.setCustomValidity('');
		    }

		    return valid;
		  }

		  beforeInput.addEventListener('input', validateBeforeAfter);
		  afterInput.addEventListener('input', validateBeforeAfter);

		  document.getElementById('goalForm').addEventListener('submit', e => {
		    if (!validateBeforeAfter()) {
		      e.preventDefault();
		      alert('í˜„ì¬ ìƒíƒœì™€ ëª©í‘œ ìƒíƒœëŠ” ëª¨ë‘ 1 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
		      return;
		    }

		    const selectedType = document.querySelector('input[name="deadlineType"]:checked').value;
		    if (selectedType === 'relative') {
		      if (!deadlineValueInput.value || !deadlineUnitSelect.value) {
		        e.preventDefault();
		        alert('ëª©í‘œ ê¸°ê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
		        return;
		      }
		    } else if (selectedType === 'absolute') {
		      if (!customDateInput.value) {
		        e.preventDefault();
		        alert('ëª©í‘œ ë§ˆê°ì¼ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
		        return;
		      }
		    }

		    // title ê°’ì„ ìƒì„±í•´ì„œ hidden í•„ë“œì— ì…ë ¥
		    const action = document.getElementById('action').value.trim();
		    const afterState = document.getElementById('afterState').value.trim();
		    const unit = document.getElementById('unit').value.trim();
		    const content = document.getElementById('content').value.trim();
		    const titleValue = `${action} ${afterState}${unit} ${content}`;
		    document.getElementById('title').value = titleValue;
		  });
		})();
		</script>
		
	</body>


</html>