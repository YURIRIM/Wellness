<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<title>습관 달성 현황</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { font-size: 1.6rem; margin-bottom: 10px; }
  #habitTitle { margin-bottom: 20px; }

  #calendarHeaderContainer {
    display: flex; justify-content: center; align-items: center; gap: 18px; margin-bottom: 12px;
  }
  #calendarHeader { font-size: 1.4rem; font-weight: bold; }
  #prevMonthBtn, #nextMonthBtn {
    background: #e2e8f0; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer;
  }

  #calendar {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 6px; max-width: 700px; margin: 0 auto 30px;
  }
  .day, .day.header {
    text-align: center; padding: 10px 0;
    border-radius: 10px;
    user-select: none;
  }
  .day.header { background: #d8dee9; font-weight: bold; }
  .day {
    border: 1.5px solid #cde0f7; color: #2a4365; font-weight: 600; cursor: default;
    min-height: 60px; position: relative;
    transition: background-color 0.3s ease;
  }
  .day.today { border-color: #3182ce; background-color: #bee3f8; font-weight: 700; }
  .day.checked { background-color: #4299e1; color: white; }
  .day.failed { background-color: #f56565; color: white; opacity: 0.7; }

  #stats {
    max-width: 700px;
    margin: 0 auto;
    display: flex; justify-content: space-around; text-align: center;
    font-weight: 600;
  }
  #stats div {
    background: #f0f4f8;
    border-radius: 10px;
    padding: 15px 20px;
    width: 150px;
    box-shadow: 0 4px 12px rgb(66 153 225 / 0.1);
  }
  #stats div h3 {
    margin: 0 0 8px;
    font-weight: 800;
  }

</style>
</head>
<script th:inline="javascript">
  var habit = /*[[${habit}]]*/ {};
  var habitChecks = /*[[${habitChecks}]]*/ [];
</script>

<body>

<h1>습관명: <span id="habitTitle" th:text="${habit.title}">운동하기</span></h1>

<!-- 달력 헤더 -->
<div id="calendarHeaderContainer">
  <button id="prevMonthBtn" aria-label="이전달">&lt;</button>
  <span id="calendarHeader"></span>
  <button id="nextMonthBtn" aria-label="다음달">&gt;</button>
</div>

<div id="calendar" aria-label="습관 달력"></div>

<!-- 달성 통계 -->
<section id="stats" aria-label="습관 달성 통계">
  <div>
    <h3 th:text="${habitStats.currentStreak} + '일'">5일</h3>
    <p>현재 연속</p>
  </div>
  <div>
    <h3 th:text="Math.round(habitStats.monthlySuccessRate * 100) + '%'">60%</h3>
    <p>이번 달 달성률</p>
  </div>
  <div>
    <h3 th:text="Math.round(habitStats.weeklySuccessRate * 100) + '%'">80%</h3>
    <p>이번 주 달성률</p>
  </div>
</section>

<script th:inline="javascript">
  const habit = /*[[${habit}]]*/ {};
  const habitChecksRaw = /*[[${habitChecks}]]*/ [];
  
  // 체크 배열 날짜를 Date객체로 변환하고 Map(키=yyyy-mm-dd)으로 상태 캐싱
  const habitChecksMap = new Map();
  habitChecksRaw.forEach(c => {
    const d = new Date(c.checkDate);
    const yyyyMMdd = d.toISOString().slice(0,10);
    habitChecksMap.set(yyyyMMdd, c.status);
  });

  let calendarYear = new Date().getFullYear();
  let calendarMonth = new Date().getMonth();

  const weekdays = ['일', '월', '화', '수', '목', '금', '토'];

  function isSameDate(a, b) {
    return a.getFullYear() === b.getFullYear() &&
      a.getMonth() === b.getMonth() &&
      a.getDate() === b.getDate();
  }

  function renderWeekdays() {
    const calendar = document.getElementById('calendar');
    weekdays.forEach(day => {
      const hd = document.createElement('div');
      hd.className = 'day header';
      hd.textContent = day;
      calendar.appendChild(hd);
    });
  }

  function renderCalendar() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = ''; // 초기화
    renderWeekdays();

    const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
    const daysInMonth = new Date(calendarYear, calendarMonth +1, 0).getDate();

    // 빈칸 만들기
    for(let i=0; i<firstDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'day';
      calendar.appendChild(empty);
    }

    const today = new Date();
    today.setHours(0,0,0,0);

    for(let d=1; d<=daysInMonth; d++) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day';
      const dt = new Date(calendarYear, calendarMonth, d);
      const dtStr = dt.toISOString().slice(0,10);
      dayDiv.textContent = d;

      if(isSameDate(dt, today)) dayDiv.classList.add('today');

      // 체크여부 있으면 색깔 표시
      if(habitChecksMap.has(dtStr)) {
        if(habitChecksMap.get(dtStr) === 1) { // 성공 체크
          dayDiv.classList.add('checked');
        } else if(habitChecksMap.get(dtStr) === 0) { // 실패 체크
          dayDiv.classList.add('failed');
        }
      }

      calendar.appendChild(dayDiv);
    }

    document.getElementById('calendarHeader').textContent = `${calendarYear}년 ${calendarMonth+1}월`;
  }

  document.getElementById('prevMonthBtn').addEventListener('click', () => {
    if(calendarMonth === 0) {
      calendarMonth = 11;
      calendarYear--;
    } else {
      calendarMonth--;
    }
    renderCalendar();
  });

  document.getElementById('nextMonthBtn').addEventListener('click', () => {
    if(calendarMonth === 11) {
      calendarMonth = 0;
      calendarYear++;
    } else {
      calendarMonth++;
    }
    renderCalendar();
  });

  window.onload = () => {
    renderCalendar();
  };
</script>
</body>
</html>
