<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title th:text="${chalDetail.title}">챌린지</title>
    <th:block th:replace="~{/common/fragment :: library}"></th:block>
    <style>
      .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }
      .profile-img-large {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
      }
      .comment-img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin: 10px 0;
      }
      .thumbnail-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
      }
      .comment-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fff;
      }
      .reply-card {
        border-left: 3px solid #007bff;
        margin-left: 30px;
        padding-left: 15px;
      }
      .chart-container {
        width: 300px;
        height: 300px;
        margin: 20px auto;
      }
      .comment-form {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
      }
      .text-count {
        font-size: 12px;
        color: #6c757d;
        text-align: right;
      }
      .hidden {
        display: none;
      }
      .comment-actions {
        margin-top: 10px;
      }
      .comment-actions button {
        margin-right: 5px;
        font-size: 12px;
        padding: 2px 8px;
      }
      .verify-cycle {
        font-size: 14px;
        color: #6c757d;
        margin-top: 5px;
      }
      #loadingSpinner {
        text-align: center;
        padding: 20px;
        display: none;
      }
    </style>
  </head>
  <body>
    <th:block th:replace="~{/common/fragment :: header}"></th:block>

    <div class="container-fluid mt-4">
      <div class="row">
        <!-- 좌측: 챌린지 상세 -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <!-- 뒤로가기 및 버튼들 -->
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  onclick="goBack()"
                >
                  <i class="bi bi-arrow-left"></i> 뒤로가기
                </button>
                <div
                  th:if="${loginUser != null and loginUser.userNo == chalDetail.userNo and chalDetail.status == 'Y'}"
                >
                  <a
                    th:href="@{/challenge/updateChal(chalNo=${chalDetail.chalNo})}"
                    class="btn btn-outline-primary btn-sm"
                    >수정하기</a
                  >
                  <button
                    type="button"
                    class="btn btn-outline-warning btn-sm"
                    onclick="closeChal()"
                  >
                    종료하기
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm"
                    onclick="deleteChal()"
                  >
                    삭제하기
                  </button>
                </div>
              </div>

              <!-- 챌린지 제목 및 상태 -->
              <div class="mb-3">
                <h2 class="card-title" th:text="${chalDetail.title}">
                  챌린지 제목
                </h2>
                <div class="d-flex align-items-center">
                  <span
                    th:if="${chalDetail.status == 'N'}"
                    class="badge bg-warning text-dark"
                    >종료</span
                  >
                  <span
                    class="badge bg-secondary ms-2"
                    th:text="${chalDetail.categoryName}"
                    >카테고리</span
                  >
                </div>
              </div>

              <!-- 썸네일 이미지 -->
              <div th:if="${chalDetail.thumbnailBase64 != null}" class="mb-3">
                <img
                  th:src="'data:image/webp;base64,' + ${chalDetail.thumbnailBase64}"
                  class="thumbnail-img"
                  alt="썸네일"
                />
              </div>

              <!-- 챌린지 내용 -->
              <div class="mb-3">
                <p class="card-text" th:text="${chalDetail.content}">
                  챌린지 내용
                </p>
              </div>

              <!-- 챌린지 정보 -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <small class="text-muted"
                    >작성일:
                    <span
                      th:text="${#temporals.format(chalDetail.createDate, 'yyyy-MM-dd HH:mm')}"
                      >2024-01-01 00:00</span
                    ></small
                  >
                </div>
                <div class="col-md-6">
                  <small class="text-muted"
                    >시작일:
                    <span
                      th:text="${#temporals.format(chalDetail.startDate, 'yyyy-MM-dd')}"
                      >2024-01-01</span
                    ></small
                  >
                </div>
              </div>

              <div class="row mb-3" th:if="${chalDetail.endDate != null}">
                <div class="col-md-6">
                  <small class="text-muted"
                    >종료일:
                    <span
                      th:text="${#temporals.format(chalDetail.endDate, 'yyyy-MM-dd')}"
                      >2024-01-01</span
                    ></small
                  >
                </div>
              </div>

              <!-- 인증 정보 -->
              <div class="verify-cycle" th:if="${chalDetail.verifyCycle != 0}">
                <strong>인증 주기:</strong> <span id="verifyCycleText"></span
                ><br />
                <strong>인증 사진:</strong>
                <span th:if="${chalDetail.pictureRequired == 'I'}"
                  >직접 촬영한 사진 필수</span
                >
                <span th:if="${chalDetail.pictureRequired == 'Y'}">필수</span>
                <span th:if="${chalDetail.pictureRequired == 'O'}">선택</span>
                <span th:if="${chalDetail.pictureRequired == 'N'}">불가</span
                ><br />
                <strong>인증 텍스트:</strong>
                <span th:if="${chalDetail.replyRequired == 'Y'}">필수</span>
                <span th:if="${chalDetail.replyRequired == 'O'}">선택</span>
                <span th:if="${chalDetail.replyRequired == 'N'}">불가</span>
              </div>

              <!-- 참여 현황 -->
              <div class="mt-4">
                <h5>참여 현황</h5>
                <div th:if="${chalDetail.participateCount == 0}">
                  <p class="text-muted">아무도 참여하지 않았어요</p>
                </div>
                <div th:unless="${chalDetail.participateCount == 0}">
                  <div class="chart-container">
                    <canvas id="participationChart"></canvas>
                  </div>
                  <div class="text-center mt-2">
                    <small class="text-muted"
                      >총 참여자:
                      <span th:text="${chalDetail.participateCount}">0</span
                      >명</small
                    >
                  </div>
                </div>
              </div>

              <!-- 챌린지 작성자 정보 -->
              <div class="mt-4">
                <h5>챌린지 작성자</h5>
                <div th:if="${chalDetail.isOpen == 'A'}">
                  <p class="text-muted">익명의 ROUTINE유저가 생성했어요</p>
                </div>
                <div th:unless="${chalDetail.isOpen == 'A'}">
                  <div
                    class="d-flex align-items-center p-3 bg-light rounded cursor-pointer"
                    th:onclick="${chalDetail.isOpen == 'Y'} ? 'location.href=\'' + @{/profile/profileDetail} + '\'' : ''"
                  >
                    <img
                      th:if="${chalDetail.pictureBase64 != null}"
                      th:src="'data:image/webp;base64,' + ${chalDetail.pictureBase64}"
                      class="profile-img-large me-3"
                      alt="프로필"
                    />
                    <div th:unless="${chalDetail.pictureBase64 != null}">
                      <i class="bi bi-person-circle fs-1 me-3"></i>
                    </div>
                    <div>
                      <h6 class="mb-1" th:text="${chalDetail.nick}">닉네임</h6>
                      <p class="mb-0 text-muted" th:text="${chalDetail.bio}">
                        자기소개
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 우측: 댓글 리스트 -->
        <div class="col-md-6">
          <!-- 챌린지 참여 영역 -->
          <div th:if="${chalDetail.loginUserIsParticipation != 'U'}">
            <div
              th:if="${chalDetail.loginUserIsParticipation == 'Y'}"
              class="comment-form"
            >
              <h5>인증하기</h5>
              <div class="d-flex align-items-center mb-3">
                <img
                  th:if="${myProfile != null and myProfile.pictureBase64 != null}"
                  th:src="'data:image/webp;base64,' + ${myProfile.pictureBase64}"
                  class="profile-img me-2"
                  alt="내 프로필"
                />
                <div
                  th:unless="${myProfile != null and myProfile.pictureBase64 != null}"
                >
                  <i class="bi bi-person-circle fs-4 me-2"></i>
                </div>
                <strong th:text="${loginUser.nick}">닉네임</strong>
              </div>

              <!-- 사진 첨부 영역 -->
              <div th:if="${chalDetail.pictureRequired != 'N'}" class="mb-3">
                <label class="form-label">
                  인증 사진
                  <span
                    th:if="${chalDetail.pictureRequired == 'I' or chalDetail.pictureRequired == 'Y'}"
                    class="text-danger"
                    >*</span
                  >
                </label>
                <input
                  type="file"
                  class="form-control"
                  id="commentImage"
                  accept="image/*"
                  onchange="uploadCommentImage(this)"
                />
                <div id="imagePreview" class="mt-2"></div>
              </div>

              <!-- 댓글 텍스트 영역 -->
              <div th:if="${chalDetail.replyRequired != 'N'}" class="mb-3">
                <label class="form-label">
                  인증 내용
                  <span
                    th:if="${chalDetail.replyRequired == 'Y'}"
                    class="text-danger"
                    >*</span
                  >
                </label>
                <textarea
                  class="form-control"
                  id="commentText"
                  rows="3"
                  maxlength="1000"
                  placeholder="인증 내용을 입력하세요..."
                  oninput="updateCharCount(this)"
                ></textarea>
                <div class="text-count"><span id="charCount">0</span>/1000</div>
              </div>

              <div class="d-flex justify-content-end">
                <button
                  type="button"
                  class="btn btn-secondary me-2"
                  onclick="resetCommentForm()"
                >
                  초기화
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="submitCommentBtn"
                  onclick="submitComment()"
                >
                  인증하기
                </button>
              </div>
            </div>

            <div
              th:if="${chalDetail.loginUserIsParticipation == 'S'}"
              class="alert alert-success text-center"
            >
              <i class="bi bi-check-circle-fill fs-3 text-success"></i>
              <p class="mb-0 mt-2">완료한 챌린지에요!</p>
            </div>

            <div
              th:if="${chalDetail.loginUserIsParticipation == 'F'}"
              class="alert alert-danger text-center"
            >
              <i class="bi bi-x-circle-fill fs-3 text-danger"></i>
              <p class="mb-0 mt-2">실패한 챌린지에요...</p>
            </div>

            <div
              th:if="${chalDetail.loginUserIsParticipation == 'N'}"
              class="text-center mb-3"
            >
              <button
                type="button"
                class="btn btn-primary btn-lg"
                onclick="participateChallenge()"
              >
                참여하기
              </button>
            </div>
          </div>

          <!-- 댓글 리스트 -->
          <div id="commentList"></div>

          <!-- 로딩 스피너 -->
          <div id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 확인 모달 -->
    <div
      class="modal fade"
      id="confirmModal"
      tabindex="-1"
      aria-labelledby="confirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">확인</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="confirmModalBody">
            정말 실행하시겠습니까?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              취소
            </button>
            <button type="button" class="btn btn-primary" id="confirmAction">
              확인
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 경고 모달 -->
    <div
      class="modal fade"
      id="alertModal"
      tabindex="-1"
      aria-labelledby="alertModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertModalLabel">알림</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="alertModalBody">메시지</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              확인
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      const catAll = /*[[${ChallengeCategory}]]*/ ["안아줘요", "싫은데요"];
      const contextPath = /*[[${rootContextPath}]]*/ "/routine";
      const loginUser = /*[[${loginUser} != null ? ${loginUser} : null]]*/ null;
      const myProfile = /*[[${myProfile}]]*/ null;
      const chalDetail = /*[[${chalDetail}]]*/ null;

      let currentPage = 0;
      let isLoading = false;
      let hasMoreComments = true;
      let currentImageUuid = null;

      // 좌측 챌린지 영역 관련 함수들
      function initializeChallengeArea() {
        // 인증 주기 텍스트 설정
        if (chalDetail.verifyCycle !== 0) {
          document.getElementById("verifyCycleText").textContent =
            getVerifyCycleText(chalDetail.verifyCycle);
        }

        // 도넛 차트 그리기
        if (chalDetail.participateCount > 0) {
          drawParticipationChart();
        }
      }

      function getVerifyCycleText(cycle) {
        if (cycle === 201) return "매일";
        if (cycle === 202) return "이틀";
        if (cycle === 203) return "사흘";
        if (cycle === 211) return "매주";
        if (cycle === 212) return "2주";
        if (cycle === 221) return "매달";

        // 요일 비트마스크 처리
        if (cycle >= 1 && cycle <= 127) {
          const days = [];
          if (cycle & 1) days.push("월");
          if (cycle & 2) days.push("화");
          if (cycle & 4) days.push("수");
          if (cycle & 8) days.push("목");
          if (cycle & 16) days.push("금");
          if (cycle & 32) days.push("토");
          if (cycle & 64) days.push("일");
          return days.join(", ") + "요일";
        }

        return "없음";
      }

      function drawParticipationChart() {
        const ctx = document
          .getElementById("participationChart")
          .getContext("2d");
        const progressRatio =
          100 - chalDetail.failRatio - chalDetail.successRatio;

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["성공", "진행중", "실패"],
            datasets: [
              {
                data: [
                  chalDetail.successRatio,
                  progressRatio,
                  chalDetail.failRatio,
                ],
                backgroundColor: ["#007bff", "#28a745", "#dc3545"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
              tooltip: {
                callbacks: {
                  afterLabel: function (context) {
                    if (context.dataIndex === 0) {
                      return "성공자: " + chalDetail.successCount + "명";
                    } else if (context.dataIndex === 1) {
                      return (
                        "진행자: " +
                        (chalDetail.participateCount -
                          chalDetail.successCount -
                          chalDetail.failCount) +
                        "명"
                      );
                    } else {
                      return "실패자: " + chalDetail.failCount + "명";
                    }
                  },
                },
              },
            },
          },
        });
      }

      function goBack() {
        window.history.back();
      }

      function closeChal() {
        showConfirmModal("챌린지를 종료하시겠습니까?", function () {
          axios
            .post(contextPath + "/challenge/closeChal", {
              chalNo: chalDetail.chalNo,
            })
            .then((response) => {
              if (response.data === "success") {
                goBack();
              } else {
                showAlert("챌린지 종료에 실패했습니다.");
              }
            })
            .catch((error) => {
              showAlert("챌린지 종료에 실패했습니다.");
            });
        });
      }

      function deleteChal() {
        showConfirmModal("챌린지를 삭제하시겠습니까?", function () {
          axios
            .post(contextPath + "/challenge/deleteChal", {
              chalNo: chalDetail.chalNo,
            })
            .then((response) => {
              if (response.data === "success") {
                goBack();
              } else {
                showAlert("챌린지 삭제에 실패했습니다.");
              }
            })
            .catch((error) => {
              showAlert("챌린지 삭제에 실패했습니다.");
            });
        });
      }

      // 우측 댓글 영역 관련 함수들
      function initializeCommentArea() {
        loadComments();
        setupInfiniteScroll();
      }

      function uploadCommentImage(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];

          // 파일 크기 및 타입 체크
          if (file.size > 5 * 1024 * 1024) {
            showAlert("파일 크기는 5MB 이하여야 합니다.");
            return;
          }

          if (!file.type.startsWith("image/")) {
            showAlert("이미지 파일만 업로드 가능합니다.");
            return;
          }

          // 이미지 리사이즈
          resizeImage(file, 1200, 1200, 0.8).then((resizedFile) => {
            // 서버에 이미지 업로드
            const formData = new FormData();
            formData.append("file", resizedFile);
            formData.append("chalNo", chalDetail.chalNo);

            document.getElementById("submitCommentBtn").disabled = true;

            axios
              .post(contextPath + "/attachment/insertComment", formData, {
                headers: {
                  "Content-Type": "multipart/form-data",
                },
              })
              .then((response) => {
                if (response.data === "joongBock") {
                  showAlert("직접 촬영한 사진만 올려주세요");
                } else if (response.data === "fail") {
                  showAlert("이미지 업로드에 실패했습니다.");
                } else {
                  currentImageUuid = response.data;
                  // 미리보기 표시
                  const reader = new FileReader();
                  reader.onload = function (e) {
                    document.getElementById("imagePreview").innerHTML =
                      '<img src="' +
                      e.target.result +
                      '" class="comment-img" alt="미리보기">';
                  };
                  reader.readAsDataURL(resizedFile);
                }
                document.getElementById("submitCommentBtn").disabled = false;
              })
              .catch((error) => {
                showAlert("이미지 업로드에 실패했습니다.");
                document.getElementById("submitCommentBtn").disabled = false;
              });
          });
        }
      }

      function resizeImage(file, maxWidth, maxHeight, quality) {
        return new Promise((resolve) => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const img = new Image();

          img.onload = function () {
            let { width, height } = img;

            // 비율 계산
            if (width > height) {
              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
              }
            }

            canvas.width = width;
            canvas.height = height;

            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(resolve, "image/jpeg", quality);
          };

          img.src = URL.createObjectURL(file);
        });
      }

      function updateCharCount(textarea) {
        const count = textarea.value.length;
        document.getElementById("charCount").textContent = count;
      }

      function resetCommentForm() {
        document.getElementById("commentText").value = "";
        document.getElementById("commentImage").value = "";
        document.getElementById("imagePreview").innerHTML = "";
        document.getElementById("charCount").textContent = "0";
        currentImageUuid = null;
      }

      function submitComment(recommentTarget = null) {
        const commentText = document.getElementById("commentText");
        const commentImage = document.getElementById("commentImage");

        // 필수 입력 검증
        if (
          chalDetail.replyRequired === "Y" &&
          (!commentText || !commentText.value.trim())
        ) {
          showAlert("댓글 내용을 입력해주세요.");
          return;
        }

        if (
          (chalDetail.pictureRequired === "I" ||
            chalDetail.pictureRequired === "Y") &&
          !currentImageUuid
        ) {
          showAlert("사진을 업로드해주세요.");
          return;
        }

        const requestData = {
          chalNo: chalDetail.chalNo,
          reply: commentText ? commentText.value : "",
          uuidStr: currentImageUuid || "",
        };

        if (recommentTarget) {
          requestData.recommentTarget = recommentTarget;
        }

        axios
          .post(contextPath + "/comment/insertComment", requestData)
          .then((response) => {
            if (response.data === "success") {
              resetCommentForm();
              // 댓글 목록 새로고침
              currentPage = 0;
              document.getElementById("commentList").innerHTML = "";
              loadComments();
            } else {
              showAlert("댓글 등록에 실패했습니다.");
            }
          })
          .catch((error) => {
            showAlert("댓글 등록에 실패했습니다.");
          });
      }

      function participateChallenge() {
        showConfirmModal("챌린지에 참여하시겠습니까?", function () {
          axios
            .post(contextPath + "/challenge/insertParticipation", {
              chalNo: chalDetail.chalNo,
            })
            .then((response) => {
              if (response.data === "success") {
                location.reload();
              } else {
                showAlert("챌린지 참여에 실패했습니다.");
              }
            })
            .catch((error) => {
              showAlert("챌린지 참여에 실패했습니다.");
            });
        });
      }

      function loadComments() {
        if (isLoading || !hasMoreComments) return;

        isLoading = true;
        document.getElementById("loadingSpinner").style.display = "block";

        axios
          .get(contextPath + "/chalComment/selectComment", {
            params: {
              chalNo: chalDetail.chalNo,
              currentPage: currentPage,
            },
            responseType: "json",
          })
          .then((response) => {
            const comments = response.data.comments || [];

            if (comments.length === 0) {
              hasMoreComments = false;
            } else {
              renderComments(comments);
              currentPage++;
            }

            isLoading = false;
            document.getElementById("loadingSpinner").style.display = "none";
          })
          .catch((error) => {
            console.error("댓글 로드 실패:", error);
            isLoading = false;
            document.getElementById("loadingSpinner").style.display = "none";
          });
      }

      function renderComments(comments) {
        const commentList = document.getElementById("commentList");

        comments.forEach((comment) => {
          const commentCard = createCommentCard(comment);
          commentList.appendChild(commentCard);
        });
      }

      function createCommentCard(comment) {
        const card = document.createElement("div");
        card.className = "comment-card";
        card.dataset.commentNo = comment.commentNo;

        if (comment.status === "D") {
          card.innerHTML = '<p class="text-muted">삭제된 댓글이네요</p>';
          return card;
        }

        let profileHtml = "";
        if (comment.isOpen === "A") {
          profileHtml =
            '<div class="d-flex align-items-center mb-2"><i class="bi bi-person-circle fs-4 me-2"></i><small class="text-muted">익명의 ROUTINE유저가 작성했어요</small></div>';
        } else {
          const profileImg = comment.pictureBase64
            ? `<img src="data:image/webp;base64,${comment.pictureBase64}" class="profile-img me-2" alt="프로필">`
            : '<i class="bi bi-person-circle fs-4 me-2"></i>';
          profileHtml = `<div class="d-flex align-items-center mb-2">${profileImg}<strong>${comment.nick}</strong></div>`;
        }

        const commentImageHtml = comment.pictureBase64
          ? `<img src="data:image/webp;base64,${comment.pictureBase64}" class="comment-img" alt="댓글 사진">`
          : "";

        const replyHtml = comment.reply
          ? `<p class="mb-2">${comment.reply}</p>`
          : "";

        const dateHtml = `<small class="text-muted">${new Date(
          comment.createDate
        ).toLocaleString()}</small>`;
        const editedHtml =
          comment.status === "M"
            ? '<span class="badge bg-info ms-2">수정됨</span>'
            : "";

        let actionsHtml = "";
        if (loginUser && loginUser.userNo === comment.userNo) {
          actionsHtml = `
                    <div class="comment-actions">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.commentNo})">수정</button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.commentNo})">삭제</button>
                    </div>
                `;
        }

        const replyButtonHtml = `
                <div class="comment-actions">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showReplyForm(${comment.commentNo})">대댓글</button>
                </div>
            `;

        card.innerHTML = `
                ${profileHtml}
                ${commentImageHtml}
                ${replyHtml}
                <div class="d-flex justify-content-between align-items-center">
                    <div>${dateHtml}${editedHtml}</div>
                </div>
                ${actionsHtml}
                ${replyButtonHtml}
                <div id="replyForm${comment.commentNo}" class="hidden mt-3"></div>
                <div id="editForm${comment.commentNo}" class="hidden mt-3"></div>
            `;

        return card;
      }

      function deleteComment(commentNo) {
        showConfirmModal("댓글을 삭제하시겠습니까?", function () {
          axios
            .post(contextPath + "/chalComment/deleteComment", {
              commentNo: commentNo,
            })
            .then((response) => {
              if (response.data === "success") {
                // 댓글 카드 업데이트
                const card = document.querySelector(
                  `[data-comment-no="${commentNo}"]`
                );
                if (card) {
                  card.innerHTML =
                    '<p class="text-muted">삭제된 댓글이네요</p>';
                }
              } else {
                showAlert("댓글 삭제에 실패했습니다.");
              }
            })
            .catch((error) => {
              showAlert("댓글 삭제에 실패했습니다.");
            });
        });
      }

      function editComment(commentNo) {
        const editForm = document.getElementById(`editForm${commentNo}`);
        if (editForm.classList.contains("hidden")) {
          editForm.classList.remove("hidden");
          editForm.innerHTML = `
                    <div class="border p-3 bg-light rounded">
                        <div class="mb-3">
                            <label class="form-label">사진 수정</label>
                            <input type="file" class="form-control" accept="image/*" onchange="uploadEditImage(this, ${commentNo})">
                            <div id="editImagePreview${commentNo}" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="editCommentText${commentNo}" rows="3" maxlength="1000" 
                                      placeholder="댓글 내용을 수정하세요..."></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" onclick="cancelEdit(${commentNo})">취소</button>
                            <button type="button" class="btn btn-primary" onclick="updateComment(${commentNo})">수정</button>
                        </div>
                    </div>
                `;
        } else {
          editForm.classList.add("hidden");
        }
      }

      function cancelEdit(commentNo) {
        const editForm = document.getElementById(`editForm${commentNo}`);
        editForm.classList.add("hidden");
      }

      function updateComment(commentNo) {
        const commentText = document.getElementById(
          `editCommentText${commentNo}`
        ).value;

        axios
          .post(contextPath + "/chalComment/updateComment", {
            commentNo: commentNo,
            reply: commentText,
            uuidStr: currentImageUuid || "1", // 이미지 변경 안함
          })
          .then((response) => {
            if (response.data === "success") {
              // 댓글 목록 새로고침
              currentPage = 0;
              document.getElementById("commentList").innerHTML = "";
              loadComments();
            } else {
              showAlert("댓글 수정에 실패했습니다.");
            }
          })
          .catch((error) => {
            showAlert("댓글 수정에 실패했습니다.");
          });
      }

      function showReplyForm(commentNo) {
        const replyForm = document.getElementById(`replyForm${commentNo}`);
        if (replyForm.classList.contains("hidden")) {
          replyForm.classList.remove("hidden");
          replyForm.innerHTML = `
                    <div class="border p-3 bg-light rounded reply-card">
                        <div class="mb-3">
                            <label class="form-label">사진 첨부</label>
                            <input type="file" class="form-control" accept="image/*" onchange="uploadReplyImage(this, ${commentNo})">
                            <div id="replyImagePreview${commentNo}" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="replyCommentText${commentNo}" rows="3" maxlength="1000" 
                                      placeholder="대댓글을 입력하세요..."></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" onclick="cancelReply(${commentNo})">취소</button>
                            <button type="button" class="btn btn-primary" onclick="submitReply(${commentNo})">등록</button>
                        </div>
                    </div>
                `;
        } else {
          replyForm.classList.add("hidden");
        }
      }

      function cancelReply(commentNo) {
        const replyForm = document.getElementById(`replyForm${commentNo}`);
        replyForm.classList.add("hidden");
      }

      function submitReply(commentNo) {
        const commentText = document.getElementById(
          `replyCommentText${commentNo}`
        ).value;

        axios
          .post(contextPath + "/chalComment/insertComment", {
            chalNo: chalDetail.chalNo,
            reply: commentText,
            uuidStr: currentImageUuid || "",
            recommentTarget: commentNo,
          })
          .then((response) => {
            if (response.data === "success") {
              cancelReply(commentNo);
              // 댓글 목록 새로고침
              currentPage = 0;
              document.getElementById("commentList").innerHTML = "";
              loadComments();
            } else {
              showAlert("대댓글 등록에 실패했습니다.");
            }
          })
          .catch((error) => {
            showAlert("대댓글 등록에 실패했습니다.");
          });
      }

      function setupInfiniteScroll() {
        window.addEventListener("scroll", function () {
          if (
            window.innerHeight + window.scrollY >=
            document.body.offsetHeight - 1000
          ) {
            loadComments();
          }
        });
      }

      // 모달 관련 함수들
      function showConfirmModal(message, callback) {
        document.getElementById("confirmModalBody").textContent = message;
        document.getElementById("confirmAction").onclick = function () {
          callback();
          bootstrap.Modal.getInstance(
            document.getElementById("confirmModal")
          ).hide();
        };
        new bootstrap.Modal(document.getElementById("confirmModal")).show();
      }

      function showAlert(message) {
        document.getElementById("alertModalBody").textContent = message;
        new bootstrap.Modal(document.getElementById("alertModal")).show();
      }

      // 페이지 로드 시 초기화
      document.addEventListener("DOMContentLoaded", function () {
        initializeChallengeArea();
        initializeCommentArea();
      });
    </script>
  </body>
</html>
