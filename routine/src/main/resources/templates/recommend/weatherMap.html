<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>날씨 기반 운동 추천 지도</title>
    <th:block th:replace="~{common/fragment :: library}"></th:block>
    <script type="text/javascript" th:src="@{'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoJsApiKey} + '&libraries=services'}"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #F7F9FC;
            color: #333;
        }
        .page-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .page-header {
            margin-bottom: 20px;
        }
        .page-header h2 {
            font-weight: 700;
            font-size: 28px;
            color: #2C3E50;
        }
        .page-header p {
            font-size: 1rem;
            color: #5D6D7E;
        }
        #weatherMapContainer {
            width: 100%;
            height: 65vh;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid #EAECEF;
            box-shadow: 0 8px 16px rgba(44, 62, 80, 0.1);
        }
        #currentLocationBtn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 2;
            background-color: #fff;
            border: 1px solid #d5d8dc;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease;
        }
        #currentLocationBtn:hover {
            background-color: #f2f2f2;
        }
        #currentLocationBtn i {
            font-size: 1.2rem;
            color: #4A90E2;
        }
        .info-window-wrap { padding: 10px; }
        .info-window-content { width: 280px; padding: 15px; font-size: 14px; line-height: 1.6; }
        .info-window-content h5 { font-weight: 600; font-size: 1.1rem; color: #2C3E50; margin: 0 0 12px 0; }
        .info-item { display: flex; align-items: center; margin-bottom: 8px; }
        .info-item i { font-size: 1.2rem; margin-right: 10px; color: #8592A0; min-width: 20px; text-align: center; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; color: #fff; }
        .status-맑음 { background-color: #4A90E2; }
        .status-흐림, .status-구름많음 { background-color: #90A4AE; }
        .status-비, .status-눈 { background-color: #546E7A; }
        .status-좋음 { background-color: #66BB6A; }
        .status-보통 { background-color: #FFEE58; color: #333; }
        .status-나쁨 { background-color: #FFA726; }
        .status-매우나쁨 { background-color: #EF5350; }
        .recommend-title { font-weight: 600; margin-top: 15px; margin-bottom: 8px; }
        .recommend-list { list-style-type: none; padding-left: 0; display: flex; flex-wrap: wrap; gap: 6px; }
        .recommend-list li { background-color: #EAECEF; border-radius: 4px; padding: 4px 10px; font-size: 12px; color: #5D6D7E; }
    </style>
</head>
<body>
    <th:block th:replace="~{common/fragment :: header}"></th:block>
    
    <div class="page-container">
        <div class="page-header">
            <h2>날씨 기반 운동 추천 지도</h2>
            <p>지도에서 각 지역의 날씨 정보와 추천 운동을 확인하세요.</p>
        </div>
        
        <div id="weatherMapContainer">
            <button id="currentLocationBtn" title="내 위치로 이동"><i class="bi bi-crosshair"></i></button>
        </div>
    </div>

    <script th:inline="javascript">
        var map, infoWindow = null, currentPosMarker = null;

        function displayInfoWindow(locationData) {
            var position = new kakao.maps.LatLng(locationData.latitude, locationData.longitude);
            if (infoWindow) infoWindow.close();

            var weather = locationData.weatherObject;
            var content = '<div class="info-window-wrap"><div class="info-window-content">';
            content += '<h5>' + (locationData.locationName || locationData.address) + '</h5>';

            if (weather) {
                var weatherIcon = weather.weatherCondition.includes('비') ? 'bi-cloud-rain' : (weather.weatherCondition.includes('눈') ? 'bi-cloud-snow' : (weather.weatherCondition.includes('흐림') || weather.weatherCondition.includes('구름') ? 'bi-cloudy' : 'bi-sun'));
                content += '<div class="info-item"><i class="bi ' + weatherIcon + '"></i><span><span class="status-badge status-' + weather.weatherCondition + '">' + weather.weatherCondition + '</span> ' + weather.temperature + '°C</span></div>';
                content += '<div class="info-item"><i class="bi bi-wind"></i><span>미세먼지 <span class="status-badge status-' + weather.airGrade + '">' + weather.airGrade + '</span> (' + weather.pm10 + '㎍/㎥)</span></div>';
                
                if (weather.recommendList && weather.recommendList.length > 0) {
                    content += '<div class="recommend-title">추천 운동</div><ul class="recommend-list">';
                    weather.recommendList.forEach(rec => {
                        content += '<li>' + rec.exerciseType + '</li>';
                    });
                    content += '</ul>';
                }
            } else {
                content += '<p>날씨 정보가 없습니다.</p>';
            }
            content += '</div></div>';

            infoWindow = new kakao.maps.InfoWindow({
                position: position,
                content: content,
                removable: true
            });
            infoWindow.open(map);
        }

        function handleLocationSelect(lat, lng) {
            var locPosition = new kakao.maps.LatLng(lat, lng);
            if (currentPosMarker) {
                currentPosMarker.setMap(null);
            }
            
            var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
            var imageSize = new kakao.maps.Size(24, 35);
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

            currentPosMarker = new kakao.maps.Marker({
                map: map,
                position: locPosition,
                image: markerImage
            });
            
            map.panTo(locPosition);

            fetch(`/routine/recommend/weather-by-coords?latitude=${lat}&longitude=${lng}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.locationNo != null) {
                    displayInfoWindow(data);
                } else {
                    if(infoWindow) infoWindow.close();
                    alert('해당 위치의 날씨 데이터를 찾을 수 없습니다.');
                }
            })
            .catch(error => {
                console.error('Error fetching weather data:', error);
                alert('날씨 데이터를 불러오는 중 오류가 발생했습니다.');
            });
        }

        window.kakao.maps.load(function() {
            var mapContainer = document.getElementById('weatherMapContainer');
            map = new kakao.maps.Map(mapContainer, {
                center: new kakao.maps.LatLng(37.566826, 126.9786567),
                level: 7
            });

            document.getElementById('currentLocationBtn').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        pos => handleLocationSelect(pos.coords.latitude, pos.coords.longitude),
                        () => alert('현재 위치를 가져올 수 없습니다. 위치 정보 접근을 허용해주세요.'),
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                } else {
                    alert('이 브라우저는 Geolocation을 지원하지 않습니다.');
                }
            });

            kakao.maps.event.addListener(map, 'click', mouseEvent => handleLocationSelect(mouseEvent.latLng.getLat(), mouseEvent.latLng.getLng()));
            
            handleLocationSelect(37.566826, 126.9786567);
        });
    </script>
</body>
</html>