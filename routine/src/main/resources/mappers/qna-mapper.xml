<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="qnaMapper">
    
    <!-- 문의사항 등록 -->
    <insert id="insertQna" parameterType="com.kh.spring.qna.model.vo.Qna">
        INSERT INTO USERQNA_INFO (
            USERQNA_NO, 
            USER_NO, 
            USERQNA_TITLE, 
            USERQNA, 
            CREATEDATE, 
            STATUS
        ) VALUES (
            QNA_SEQ.NEXTVAL, 
            #{userNo}, 
            #{userQnaTitle}, 
            #{userQna}, 
            SYSDATE, 
            0
        )
    </insert>
    
    <!-- 특정 사용자의 문의사항 개수 조회 -->
    <select id="selectQnaCountByUser" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM USERQNA_INFO
        WHERE USER_NO = #{userNo}
    </select>
    
    <!-- 특정 사용자의 문의사항 목록 조회 -->
    <select id="selectQnaListByUser" parameterType="int" resultType="com.kh.spring.qna.model.vo.Qna">
        SELECT 
            USERQNA_NO as userQnaNo,
            USER_NO as userNo,
            USERQNA_TITLE as userQnaTitle,
            USERQNA as userQna,
            CREATEDATE as createdate,
            CASE WHEN STATUS = 1 THEN 1 ELSE 0 END as status
        FROM USERQNA_INFO
        WHERE USER_NO = #{userNo}
        ORDER BY USERQNA_NO DESC
    </select>
    
    <!-- 문의사항 상세 조회 -->
    <select id="selectQnaByNo" parameterType="int" resultType="com.kh.spring.qna.model.vo.Qna">
        SELECT 
            USERQNA_NO as userQnaNo,
            USER_NO as userNo,
            USERQNA_TITLE as userQnaTitle,
            USERQNA as userQna,
            CREATEDATE as createdate,
            CASE WHEN STATUS = 1 THEN 1 ELSE 0 END as status
        FROM USERQNA_INFO
        WHERE USERQNA_NO = #{userQnaNo}
    </select>
    
    <!-- 전체 문의사항 목록 조회 (관리자용) -->
    <select id="selectAllQnaList" resultType="com.kh.spring.qna.model.vo.Qna">
        SELECT 
            USERQNA_NO as userQnaNo,
            USER_NO as userNo,
            USERQNA_TITLE as userQnaTitle,
            USERQNA as userQna,
            CREATEDATE as createdate,
            CASE WHEN STATUS = 1 THEN 1 ELSE 0 END as status
        FROM USERQNA_INFO
        ORDER BY USERQNA_NO DESC
    </select>
    
    <!-- 미답변 문의사항 목록 조회 -->
    <select id="selectUnansweredQnaList" resultType="com.kh.spring.qna.model.vo.Qna">
        SELECT 
            USERQNA_NO as userQnaNo,
            USER_NO as userNo,
            USERQNA_TITLE as userQnaTitle,
            USERQNA as userQna,
            CREATEDATE as createdate,
            CASE WHEN STATUS = 1 THEN 1 ELSE 0 END as status
        FROM USERQNA_INFO
        WHERE STATUS = 0
        ORDER BY USERQNA_NO DESC
    </select>
    
    <!-- 답변완료 문의사항 목록 조회 -->
    <select id="selectAnsweredQnaList" resultType="com.kh.spring.qna.model.vo.Qna">
        SELECT 
            USERQNA_NO as userQnaNo,
            USER_NO as userNo,
            USERQNA_TITLE as userQnaTitle,
            USERQNA as userQna,
            CREATEDATE as createdate,
            CASE WHEN STATUS = 1 THEN 1 ELSE 0 END as status
        FROM USERQNA_INFO
        WHERE STATUS = 1
        ORDER BY USERQNA_NO DESC
    </select>
    
    <!-- 전체 문의사항 개수 조회 -->
    <select id="selectQnaCount" resultType="int">
        SELECT COUNT(*)
        FROM USERQNA_INFO
    </select>
    
    <!-- 미답변 문의사항 개수 조회 -->
    <select id="selectUnansweredQnaCount" resultType="int">
        SELECT COUNT(*)
        FROM USERQNA_INFO
        WHERE STATUS = 0
    </select>
    
    <!-- 답변완료 문의사항 개수 조회 -->
    <select id="selectAnsweredQnaCount" resultType="int">
        SELECT COUNT(*)
        FROM USERQNA_INFO
        WHERE STATUS = 1
    </select>
    
    <!-- 최근 문의사항 조회 (대시보드용) -->
    <select id="selectRecentQnas" parameterType="int" resultType="com.kh.spring.qna.model.vo.Qna">
        SELECT 
            USERQNA_NO as userQnaNo,
            USER_NO as userNo,
            USERQNA_TITLE as userQnaTitle,
            USERQNA as userQna,
            CREATEDATE as createdate,
            CASE WHEN STATUS = 1 THEN 1 ELSE 0 END as status
        FROM (
            SELECT USERQNA_NO, USER_NO, USERQNA_TITLE, USERQNA, CREATEDATE, STATUS
            FROM USERQNA_INFO
            ORDER BY USERQNA_NO DESC
        )
        WHERE ROWNUM &lt;= #{limit}
    </select>
    
    <!-- 문의사항 답변 상태 변경 -->
    <update id="updateQnaStatus" parameterType="map">
        UPDATE USERQNA_INFO 
        SET STATUS = #{status}
        WHERE USERQNA_NO = #{userQnaNo}
    </update>
    
    <!-- 문의사항 수정 -->
    <update id="updateQna" parameterType="com.kh.spring.qna.model.vo.Qna">
        UPDATE USERQNA_INFO 
        SET 
            USERQNA_TITLE = #{userQnaTitle},
            USERQNA = #{userQna}
        WHERE USERQNA_NO = #{userQnaNo}
    </update>
    
    <!-- 문의사항 삭제 -->
    <delete id="deleteQna" parameterType="int">
        DELETE FROM USERQNA_INFO
        WHERE USERQNA_NO = #{userQnaNo}
    </delete>
    
</mapper>