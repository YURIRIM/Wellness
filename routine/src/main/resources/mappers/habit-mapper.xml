<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="habitMapper">

<resultMap id="habitResultMap" type="Habit">
    <id property="habitNo" column="habit_no"/>
    <result property="userNo" column="user_no"/>
    <result property="goalNo" column="goal_no"/>
    <result property="title" column="title"/>
    <result property="what" column="what"/>
    <result property="amount" column="amount"/>
    <result property="unit" column="unit"/>
    <result property="startDate" column="start_date"/>
    <result property="isChallenge" column="is_challenge"/>
    <result property="totalCheck" column="total_check"/>
    <result property="currentCheck" column="current_check"/>
    <result property="maxCheck" column="max_check"/>
    <result property="status" column="status"/>
    <result property="lastCheck" column="last_check"/>
    <result property="action" column="action"/>


    <association property="repeat" javaType="HabitRepeat" resultMap="habitRepeatResultMap" />
</resultMap>

<!-- HabitRepeat resultMap 예시 -->
<resultMap id="habitRepeatResultMap" type="HabitRepeat">
    <id property="repeatId" column="repeat_id"/>
    <result property="habitNo" column="habit_no"/>
    <result property="repeatType" column="repeat_type"/>
    <result property="interval" column="interval"/>
    <result property="weekDaysInterval" column="week_days_interval"/>
    <result property="weekDays" column="week_days"/>
    <result property="nthWeeks" column="nth_weeks"/>
    <result property="allDay" column="all_day"/>
    <result property="repeatTime" column="repeat_time"/>
</resultMap>



	
	
	
	
	

    <!-- 전체 목록 조회 -->
    <select id="habitList" resultMap="habitResultMap">
        SELECT * FROM HABIT
        ORDER BY HABIT_NO
    </select>

    <!-- 한 건 조회 (PK 기준) -->
    <select id="selectHabitByNo" parameterType="_int" resultMap="habitResultMap">
        SELECT * FROM HABIT WHERE HABIT_NO = #{habitNo}
    </select>

    <!-- 삽입 -->
	  <insert id="insertHabit" parameterType="Habit" useGeneratedKeys="false" keyProperty="habitNo">
    <selectKey keyProperty="habitNo" resultType="_int" order="BEFORE">
      SELECT HABIT_SEQ.NEXTVAL FROM DUAL
    </selectKey>
		 INSERT INTO habit (habit_no, user_no, goal_no, title, what, amount, unit, action, start_date, is_challenge, total_check, current_check, max_check, status, last_check)
    VALUES (
  #{habitNo}, #{userNo}, #{goalNo},#{what} || ' ' || #{amount} || #{unit} || ' ' || #{action}, #{what}, #{amount}, #{unit},#{action},
  #{startDate}, #{isChallenge}, #{totalCheck}, #{currentCheck}, #{maxCheck}, #{status}, #{lastCheck}
)
  </insert>
  
     <!-- HabitRepeat 삽입 -->
  <insert id="insertHabitRepeat" parameterType="HabitRepeat">
    INSERT INTO habit_repeat (
      repeat_id, habit_no, repeat_type, interval, week_days_interval, week_days,
      nth_weeks, all_day, repeat_time
    )
    VALUES (
      habit_repeat_seq.NEXTVAL, #{habitNo}, #{repeatType}, #{interval}, #{weekDaysInterval}, #{weekDays},
      #{nthWeeks}, #{allDay}, #{repeatTime}
    )
  </insert>


    
    
    
    
    
    
    <select id="selectById" parameterType="_int" resultType="Habit">
        SELECT * FROM HABIT WHERE HABIT_NO = #{habitNo}
    </select>

    <update id="updateHabit" parameterType="Habit">
        UPDATE HABIT
        SET TITLE = #{title},
            GOAL_NO = #{goalNo},
            UPDATED_AT = SYSDATE
        WHERE HABIT_NO = #{habitNo}
    </update>

    <delete id="deleteStreakRewardsByHabitNo" parameterType="_int">
	    DELETE FROM STREAK_REWARD
	    WHERE HABIT_NO = #{habitNo}
	</delete>
	
	<delete id="deleteHabitChecks" parameterType="_int">
	    DELETE FROM HABIT_CHECK
	    WHERE HABIT_NO = #{habitNo}
	</delete>
	
	<delete id="deleteHabitRepeats" parameterType="_int">
	    DELETE FROM HABIT_REPEAT
	    WHERE HABIT_NO = #{habitNo}
	</delete>
    
    
    <delete id="deleteHabit" parameterType="_int">
        DELETE FROM HABIT 
        WHERE HABIT_NO = #{habitNo}
    </delete>
    
     <select id="selectGoalsWithHabitsByUser" parameterType="int" resultMap="goalResultMap" fetchSize="100">
    SELECT 
      g.GOAL_NO, g.USER_NO, g.TITLE, g.CONTENT, g.START_DATE, g.END_DATE, g.STATUS,
      g.GOAL_CATEGORY, g.WHY_GOAL, g.ACTION, g.BEFORE_STATE, g.AFTER_STATE, g.UNIT,
      g.DEADLINE_TYPE, g.DEADLINE_VALUE, g.DEADLINE_UNIT,
      h.HABIT_NO, h.USER_NO AS HABIT_USER_NO, h.GOAL_NO AS HABIT_GOAL_NO, h.TITLE AS HABIT_TITLE,
      h.WHAT, h.AMOUNT, h.UNIT AS HABIT_UNIT, h.ACTION AS HABIT_ACTION, h.START_DATE AS HABIT_START_DATE,
      h.IS_CHALLENGE, h.TOTAL_CHECK, h.CURRENT_CHECK, h.MAX_CHECK, h.STATUS AS HABIT_STATUS, h.LAST_CHECK
    FROM GOAL g
    LEFT JOIN HABIT h ON g.GOAL_NO = h.GOAL_NO
    WHERE g.USER_NO = #{userNo}
    ORDER BY g.START_DATE DESC, h.HABIT_NO DESC
  </select>
	
	

</mapper>
